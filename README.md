**RAGã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¸** [ãƒªãƒ³ã‚¯](README_RAG.md)

## Geminiæ­è¼‰ãƒ»è‡ªç«‹å‹RAGã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ 

![agent_lp](doc/assets/agent_1.png)

# Agent RAG ã‚·ã‚¹ãƒ†ãƒ 

æœ¬ã‚·ã‚¹ãƒ†ãƒ ã¯ã€ã€Œè‡ªå¾‹å‹ RAG ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã€ãŠã‚ˆã³çµ±åˆç®¡ç†ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ã™ã€‚
ã‚·ã‚¹ãƒ†ãƒ ã®ç‰¹å¾´ï¼ˆReAct + Reflectionã€ãƒ•ãƒ«ã‚¹ã‚¯ãƒ©ãƒƒãƒå®Ÿè£…ã€Gemini 3ä¸–ä»£å¯¾å¿œï¼‰ã§ã™ã€‚
Streamlitãƒ™ãƒ¼ã‚¹ã®UIã‚’é€šã˜ã¦ã€ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ãƒ»ãƒ™ã‚¯ãƒˆãƒ«åŒ–ã‹ã‚‰ã€Qdrant ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†ã€
ãã—ã¦é«˜åº¦ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå¯¾è©±ã¾ã§ã€RAG ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å…¨ä½“ã‚’ä¸€æ°—é€šè²«ã§ç®¡ç†ãƒ»é‹ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

**ä¸»ãªç‰¹å¾´ã¨æŠ€è¡“çš„å·¥å¤«:**

1. ReAct (Reasoning + Acting):
   ã€€ã€€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè‡ªã‚‰ãŒã€Œè€ƒãˆã‚‹ï¼ˆReasoningï¼‰ã€ã¨ã€Œè¡Œå‹•ã™ã‚‹ï¼ˆActingï¼‰ã€ã‚’ãƒ«ãƒ¼ãƒ—
   ã€€ã€€ãƒ»å…¥åŠ›ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æœ€é©åŒ–
   ã€€ã€€ãƒ»CoTï¼ˆChain-of-Thought)ã®Loop
   ã€€ã€€ãƒ»Hybrid RAG (Dense + Sparse)ã®æ¤œç´¢
   ã€€ã€€å¿…è¦ãªæƒ…å ±ãŒæƒã†ã¾ã§è‡ªå¾‹çš„ã«æ¤œç´¢ãƒ„ãƒ¼ãƒ« (search_rag_knowledge_base) ã‚’è¡Œä½¿ã—ã¾ã™ã€‚
2. Reflection (è‡ªå·±è©•ä¾¡çµæœã«åŸºã¥ãã€æœ€çµ‚å›ç­” (Final Answer) ã‚’æŠ½å‡ºï¼šè‡ªå·±çœå¯Ÿ):
   ã€€ã€€å›ç­”ã‚’ä½œæˆã—ãŸå¾Œã€å³åº§ã«å‡ºåŠ›ã›ãšã€Œè‡ªå·±è©•ä¾¡ã€ãƒ•ã‚§ãƒ¼ã‚ºã‚’å®Ÿè¡Œã—ã€å›ç­”ã®å“è³ªã‚’å‘ä¸Šã€‚
   ã€€ã€€æ¤œç´¢çµæœã¨ã®æ•´åˆæ€§ã‚„ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è‡ªã‚‰æ‰¹è©•ã—ã€ãƒãƒ«ã‚·ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå¹»è¦šï¼‰ã‚„èª¤ã‚Šã‚’ä¿®æ­£ã—ã¦ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å›ç­”ã—ã¾ã™ã€‚
3. ãƒ•ãƒ«ã‚¹ã‚¯ãƒ©ãƒƒãƒå®Ÿè£…:
   ã€€ã€€Gemini APIã‚’ç›´æ¥åˆ©ç”¨ã—ã€æŸ”è»Ÿãªåˆ¶å¾¡ã‚’å®Ÿç¾ã—ã¾ã—ãŸã€‚

![agent_overall](doc/assets/agent_4_react_reflection.png)

## ç›®æ¬¡

## RAG Q/A ç”Ÿæˆãƒ»æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ 

1. [æ¦‚è¦](#1-æ¦‚è¦)
   - 1.1 [æœ¬ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ç›®çš„](#11-æœ¬ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ç›®çš„)
   - 1.2 [ä¸»ãªæ©Ÿèƒ½ï¼ˆ7ç”»é¢ã®æ¦‚è¦ï¼‰](#12-ä¸»ãªæ©Ÿèƒ½7ç”»é¢ã®æ¦‚è¦)
   - 1.3 [å¯¾å¿œãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ](#13-å¯¾å¿œãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ)
2. [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#2-ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
   - 2.1 [ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆå›³ï¼ˆ3å±¤ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼‰](#21-ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆå›³3å±¤ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
   - 2.2 [ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä¾å­˜é–¢ä¿‚å›³](#22-ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä¾å­˜é–¢ä¿‚å›³)
   - 2.3 [ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¥å½¹å‰²åˆ†æ‹…è¡¨](#23-ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¥å½¹å‰²åˆ†æ‹…è¡¨)
   - 2.4 [ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³ï¼ˆMermaidï¼‰](#24-ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³mermaid)
   - 2.5 [ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé€£æºã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³](#25-ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé€£æºã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³)
3. [ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼](#3-ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼)
   - 3.1 [ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰å‡¦ç†ãƒ•ãƒ­ãƒ¼å›³](#31-ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰å‡¦ç†ãƒ•ãƒ­ãƒ¼å›³)
   - 3.2 [å„ã‚¹ãƒ†ãƒƒãƒ—ã®å…¥å‡ºåŠ›](#32-å„ã‚¹ãƒ†ãƒƒãƒ—ã®å…¥å‡ºåŠ›)
   - 3.3 [ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ](#33-ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ )
4. [ã‚µãƒ¼ãƒ“ã‚¹å±¤ & ãƒ„ãƒ¼ãƒ«å±¤](#4-ã‚µãƒ¼ãƒ“ã‚¹å±¤--ãƒ„ãƒ¼ãƒ«å±¤)
   - 4.1 [dataset_service.py - ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆæ“ä½œ](#41-dataset_servicepy---ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆæ“ä½œ)
   - 4.2 [qdrant_service.py - Qdrantæ“ä½œ](#42-qdrant_servicepy---qdrantæ“ä½œ)
   - 4.3 [file_service.py - ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œ](#43-file_servicepy---ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œ)
   - 4.4 [qa_service.py - Q/Aç”Ÿæˆ](#44-qa_servicepy---qaç”Ÿæˆ)
   - 4.5 [agent_tools.py - ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç”¨ãƒ„ãƒ¼ãƒ«](#45-agent_toolspy---ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç”¨ãƒ„ãƒ¼ãƒ«)
5. [UIå±¤ (ui/pages/)](#5-uiå±¤-uipages)
   - 5.1 [ç”»é¢ä¸€è¦§ã¨é·ç§»](#51-ç”»é¢ä¸€è¦§ã¨é·ç§»)
   - 5.2 [å„ãƒšãƒ¼ã‚¸ã®æ©Ÿèƒ½è©³ç´°](#52-å„ãƒšãƒ¼ã‚¸ã®æ©Ÿèƒ½è©³ç´°)
6. [ãƒ¡ãƒ‹ãƒ¥ãƒ¼å˜ä½ã®å‡¦ç†æ¦‚è¦ãƒ»å‡¦ç†æ–¹å¼](#6-ãƒ¡ãƒ‹ãƒ¥ãƒ¼å˜ä½ã®å‡¦ç†æ¦‚è¦å‡¦ç†æ–¹å¼)
   - 6.1 [ğŸ“– èª¬æ˜](#61--èª¬æ˜)
   - 6.2 [ğŸ¤– ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå¯¾è©±](#62--ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå¯¾è©±)
   - 6.3 [ğŸ“Š æœªå›ç­”ãƒ­ã‚°](#63--æœªå›ç­”ãƒ­ã‚°)
   - 6.4 [ğŸ“¥ RAGãƒ‡ãƒ¼ã‚¿ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰](#64--ragãƒ‡ãƒ¼ã‚¿ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰)
   - 6.5 [ğŸ¤– Q/Aç”Ÿæˆ](#65--qaç”Ÿæˆ)
   - 6.6 [ğŸ“¥ CSVãƒ‡ãƒ¼ã‚¿ç™»éŒ²](#66--csvãƒ‡ãƒ¼ã‚¿ç™»éŒ²)
   - 6.7 [ğŸ—„ï¸ Qdrantãƒ‡ãƒ¼ã‚¿ç®¡ç†](#67--qdrantãƒ‡ãƒ¼ã‚¿ç®¡ç†)
   - 6.8 [ğŸ” Qdrantæ¤œç´¢](#68--qdrantæ¤œç´¢)
7. [è¨­å®šãƒ»ä¾å­˜é–¢ä¿‚](#7-è¨­å®šä¾å­˜é–¢ä¿‚)
   - 7.1 [å¿…é ˆç’°å¢ƒå¤‰æ•°](#71-å¿…é ˆç’°å¢ƒå¤‰æ•°)
   - 7.2 [ä¾å­˜ã‚µãƒ¼ãƒ“ã‚¹](#72-ä¾å­˜ã‚µãƒ¼ãƒ“ã‚¹)
   - 7.3 [ä¸»è¦ãªå®šæ•°ãƒ»è¨­å®šå€¤](#73-ä¸»è¦ãªå®šæ•°è¨­å®šå€¤)
8. [ä½¿ç”¨æ–¹æ³•](#8-ä½¿ç”¨æ–¹æ³•)
   - 8.1 [èµ·å‹•æ‰‹é †](#81-èµ·å‹•æ‰‹é †)
   - 8.2 [å…¸å‹çš„ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼](#82-å…¸å‹çš„ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼)
9. [ReAct ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè©³ç´°è¨­è¨ˆ](#9-react-ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè©³ç´°è¨­è¨ˆ)
   - 9.1 [ReAct ãƒ«ãƒ¼ãƒ—ã®ä»•çµ„ã¿](#91-react-ãƒ«ãƒ¼ãƒ—ã®ä»•çµ„ã¿)
   - 9.2 [ä¸»è¦ã‚¯ãƒ©ã‚¹ãƒ»é–¢æ•° IPO å®šç¾©](#92-ä¸»è¦ã‚¯ãƒ©ã‚¹é–¢æ•°-ipo-å®šç¾©)
   - 9.3 [ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­è¨ˆ](#93-ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­è¨ˆ)
   - 9.4 [ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ (Agent Turn)](#94-ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³-agent-turn)

---

## 1. æ¦‚è¦

![agent_2_gaiyo.png](doc/assets/agent_2_gaiyo.png)

### 1.1 æœ¬ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ç›®çš„

`agent_rag.py` ã¯ã€**Gemini 3 (2.0 Flash)** ä¸–ä»£ã«å¯¾å¿œã—ãŸRAGï¼ˆRetrieval-Augmented Generationï¼‰ã‚·ã‚¹ãƒ†ãƒ ã®çµ±åˆç®¡ç†ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚

**ä¸€è¨€ã§è¨€ã†ã¨**: Geminiæ´»ç”¨å‹RAG Q&Aç”Ÿæˆãƒ»Qdrantç®¡ç†ã€ãŠã‚ˆã³ **ReActå‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ** ã«ã‚ˆã‚‹å¯¾è©±ã‚’å®Ÿç¾ã™ã‚‹çµ±åˆStreamlitã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³

**å½¹å‰²**:

- ãƒ‡ãƒ¼ã‚¿å–å¾—ã‹ã‚‰ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã¾ã§ã® **RAGãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å…¨ä½“** ã‚’ç®¡ç†
- **ReActã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ** ã‚’ä»‹ã—ãŸã€ãƒ„ãƒ¼ãƒ«åˆ©ç”¨ã«ã‚ˆã‚‹é«˜åº¦ãªå¯¾è©±æ©Ÿèƒ½
- **Gemini API** (`gemini-2.0-flash`, `gemini-embedding-001`) ã‚’å…¨é¢çš„ã«æ¡ç”¨ã—ã€é«˜é€Ÿãƒ»ä½ã‚³ã‚¹ãƒˆãƒ»é«˜ç²¾åº¦ã‚’å®Ÿç¾


| é …ç›®           | å†…å®¹                                            |
| -------------- | ----------------------------------------------- |
| ãƒ•ã‚¡ã‚¤ãƒ«å     | agent_rag.py                                    |
| ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ | Streamlit                                       |
| èµ·å‹•ã‚³ãƒãƒ³ãƒ‰   | `streamlit run agent_rag.py --server.port=8500` |

### 1.2 ä¸»ãªæ©Ÿèƒ½ï¼ˆ7ç”»é¢ã®æ¦‚è¦ï¼‰


| ç”»é¢             | ã‚¢ã‚¤ã‚³ãƒ³ | æ©Ÿèƒ½æ¦‚è¦                                                                                                   |
| ---------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| èª¬æ˜             | ğŸ“–       | ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ãƒ»ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã‚’è¡¨ç¤º                                                             |
| ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå¯¾è©± | ğŸ¤–       | **ReAct Agent** (Gemini 2.0) ã¨ã®å¯¾è©±ã€‚ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹æ¤œç´¢ + **Reflection (è‡ªå·±æ¨æ•²)** ã«ã‚ˆã‚‹é«˜å“è³ªãªå›ç­”ã€‚ |
| æœªå›ç­”ãƒ­ã‚°       | ğŸ“Š       | ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå›ç­”ã§ããªã‹ã£ãŸè³ªå•ã®ãƒ­ã‚°åˆ†æ                                                               |
| RAGãƒ‡ãƒ¼ã‚¿DL      | ğŸ“¥       | HuggingFace/ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ»å‰å‡¦ç†                                                         |
| Q/Aç”Ÿæˆ          | ğŸ¤–       | **Gemini 2.0 Flash** ã«ã‚ˆã‚‹Q&Aãƒšã‚¢è‡ªå‹•ç”Ÿæˆï¼ˆCeleryä¸¦åˆ—å‡¦ç†å¯¾å¿œï¼‰                                           |
| CSVãƒ‡ãƒ¼ã‚¿ç™»éŒ²    | ğŸ“¥       | **Gemini Embedding (3072æ¬¡å…ƒ)** ã§ãƒ™ã‚¯ãƒˆãƒ«åŒ–ãƒ»ç™»éŒ²ãƒ»ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³çµ±åˆ                                       |
| Qdrantãƒ‡ãƒ¼ã‚¿ç®¡ç† | ğŸ—„ï¸     | Qdrantã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å†…å®¹ã®é–²è¦§ (Show-Qdrant)                                                                 |
| Qdrantæ¤œç´¢       | ğŸ”       | ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ¤œç´¢å˜ä½“ã®ãƒ†ã‚¹ãƒˆãƒ»AIå¿œç­”ç”Ÿæˆ                                                                 |

**ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»å…¨æ©Ÿèƒ½** ![integration](doc/assets/rag_integration_app.png)

- ç”»é¢ï¼š
  ![lp.png](assets/lp.png?t=1765400877187)

### 1.3 å¯¾å¿œãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ


| ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ    | è­˜åˆ¥å­          | èª¬æ˜                                   |
| --------------- | --------------- | -------------------------------------- |
| Wikipediaæ—¥æœ¬èª | `wikipedia_ja`  | Wikipediaæ—¥æœ¬èªç‰ˆ                      |
| CC-News         | `cc_news`       | CC-Newsè‹±èªãƒ‹ãƒ¥ãƒ¼ã‚¹                    |
| Livedoor        | `livedoor`      | Livedoorãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‘ã‚¹               |
| ã‚«ã‚¹ã‚¿ãƒ         | `custom_upload` | ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆCSV/TXT/JSON/JSONLï¼‰ |

---

## 2. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### 2.1 ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆå›³ï¼ˆ3å±¤ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼‰

```mermaid
graph TD
    subgraph Presentation [ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å±¤]
        Entry["agent_rag.py"]
        Pages["ui/pages/*.py"]
        Entry --- Pages
    end

    subgraph BusinessLogic [ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å±¤]
        Services["services/"]
        Tools["agent_tools.py"]
        Services --- Tools
    end

    subgraph DataAccess [ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å±¤]
        API["Gemini API (2.0 Flash / Embed)"]
        DB["Qdrant"]
    end

    Presentation --> BusinessLogic
    BusinessLogic --> DataAccess
```

### 2.2 ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä¾å­˜é–¢ä¿‚å›³

```mermaid
graph LR
    Main["agent_rag.py"]

    subgraph UI_Pages ["ui/pages/"]
        InitUI["__init__.py"]
        AgentPage["agent_chat_page.py"]
        LogPage["log_viewer_page.py"]
        OtherPages["... (download, qa, etc.)"]
    end

    subgraph Logic_Layer ["Logic"]
        Tools["agent_tools.py"]
        QS["qdrant_service.py"]
        LogSvc["services/log_service.py"]
    end

    subgraph Helper_Layer ["Helpers"]
        HelperRag["helper_rag.py"]
        QdrantWrapper["qdrant_client_wrapper.py"]
    end

    Main --> InitUI
    InitUI --> AgentPage
    InitUI --> LogPage
    InitUI --> OtherPages

    AgentPage --> Tools
    AgentPage --> QS
    AgentPage --> LogSvc
    Tools --> QdrantWrapper

    OtherPages --> QS
```

### 2.3 ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¥å½¹å‰²åˆ†æ‹…è¡¨


| ãƒ¬ã‚¤ãƒ¤ãƒ¼             | ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«                    | è²¬å‹™                                                         |
| -------------------- | ----------------------------- | ------------------------------------------------------------ |
| **ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ** | `agent_rag.py`                | ã‚¢ãƒ—ãƒªèµ·å‹•ã€ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°                                     |
| **UIå±¤**             | `ui/pages/agent_chat_page.py` | ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå¯¾è©±UIã€ReActãƒ«ãƒ¼ãƒ—åˆ¶å¾¡ (`run_agent_turn`)       |
| **ãƒ„ãƒ¼ãƒ«å±¤**         | `agent_tools.py`              | ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒåˆ©ç”¨ã™ã‚‹ãƒ„ãƒ¼ãƒ«ç¾¤ (`search_rag_knowledge_base`) |
| **ã‚µãƒ¼ãƒ“ã‚¹å±¤**       | `services/*.py`               | ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã€DBæ“ä½œã®æŠ½è±¡åŒ–                                   |

ãƒ»3å±¤ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
![3Layer](doc/assets/agent_3_3_layer.png)

### 2.4 ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³ï¼ˆMermaidï¼‰

```mermaid
graph TB
    subgraph UI
        Entry[EntryPoint]
        AgentUI[Agent Chat Page]
    end

    subgraph AgentLogic
        ReAct[ReAct Engine<br>run_agent_turn]
        Tools[Agent Tools<br>search_rag / list_collections]
    end

    subgraph External
        Gemini[Gemini ]
        Qdrant[Qdrant Vector DB]
    end

    Entry --> AgentUI
    AgentUI --> ReAct
    ReAct -- "Prompt + History" --> Gemini
    Gemini -- "Function Call" --> ReAct
    ReAct -- "Execute" --> Tools
    Tools -- "Search" --> Qdrant
    Qdrant -- "Documents" --> Tools
    Tools -- "Observation" --> ReAct
    ReAct -- "Observation" --> Gemini
    Gemini -- "Final Answer" --> ReAct
    ReAct --> AgentUI
```

---

## 3. ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

(åŸºæœ¬æ§‹æˆã¯æ—¢å­˜ã¨åŒæ§˜ã€‚RAGãƒ‡ãƒ¼ã‚¿ç”Ÿæˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¯å¤‰æ›´ãªã—)

### 3.1 ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰å‡¦ç†ãƒ•ãƒ­ãƒ¼å›³

1. ãƒ‡ãƒ¼ã‚¿DL -> 2. å‰å‡¦ç†ï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæœ€é©åŒ–ã€ãƒãƒ£ãƒ³ã‚¯ï¼‰ -> 3. QAç”Ÿæˆ -> 4. åŸ‹ã‚è¾¼ã¿ç™»éŒ² -> **5. ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ã‚ˆã‚‹æ´»ç”¨ (Search & Answer)**

![DataFlow](doc/assets/agent_10_pipeline.png)
---------------------------------------------

## 4. ã‚µãƒ¼ãƒ“ã‚¹å±¤ & ãƒ„ãƒ¼ãƒ«å±¤

### 4.5 agent_tools.py - ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç”¨ãƒ„ãƒ¼ãƒ«

**è²¬å‹™**: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå¤–éƒ¨ç’°å¢ƒï¼ˆQdrantï¼‰ã¨å¯¾è©±ã™ã‚‹ãŸã‚ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æä¾›ã€‚


| é–¢æ•°å                      | èª¬æ˜                                                                           | é–¢é€£ãƒ„ãƒ¼ãƒ«åï¼ˆLLMå´ï¼‰       |
| --------------------------- | ------------------------------------------------------------------------------ | --------------------------- |
| `search_rag_knowledge_base` | æŒ‡å®šã•ã‚ŒãŸã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ã‚¯ã‚¨ãƒªã«é–¢é€£ã™ã‚‹æƒ…å ±ã‚’æ¤œç´¢ã™ã‚‹ã€‚ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã‚’å®Ÿè¡Œã€‚ | `search_rag_knowledge_base` |
| `list_rag_collections`      | åˆ©ç”¨å¯èƒ½ãªQdrantã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ä¸€è¦§ã‚’è¿”ã™ã€‚                                     | `list_rag_collections`      |

---

## 5. UIå±¤ (ui/pages/)

### 5.1 ç”»é¢ä¸€è¦§ã¨é·ç§»

ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã«ã‚ˆã‚Šã€ä»¥ä¸‹ã®ç”»é¢ã‚’åˆ‡ã‚Šæ›¿ãˆã€‚

1. **èª¬æ˜ (`explanation`)**
2. **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå¯¾è©± (`agent_chat`)**
3. **æœªå›ç­”ãƒ­ã‚° (`log_viewer`)**
4. **RAGãƒ‡ãƒ¼ã‚¿DL (`rag_download`)**
5. **Q/Aç”Ÿæˆ (`qa_generation`)**
6. **CSVãƒ‡ãƒ¼ã‚¿ç™»éŒ² (`qdrant_registration`)**
7. **Qdrantãƒ‡ãƒ¼ã‚¿ç®¡ç† (`show_qdrant`)**
8. **Qdrantæ¤œç´¢ (`qdrant_search`)**

### 5.2 å„ãƒšãƒ¼ã‚¸ã®æ©Ÿèƒ½è©³ç´°

#### `agent_chat_page.py` (ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå¯¾è©±)

* **æ©Ÿèƒ½**: Gemini 2.0 Flash ã‚’ç”¨ã„ãŸãƒãƒ£ãƒƒãƒˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã€‚
* **ç‰¹å¾´**:
  * **ReActãƒ«ãƒ¼ãƒ—**: æ€è€ƒ(Thought)ã¨è¡Œå‹•(Action)ã®å¯è¦–åŒ–ã€‚
  * **Reflection**: å›ç­”æ¡ˆç”Ÿæˆå¾Œã«è‡ªå·±è©•ä¾¡ãƒ»ä¿®æ­£ã‚’è¡Œã„ã€ãƒãƒ«ã‚·ãƒãƒ¼ã‚·ãƒ§ãƒ³ã®ä½æ¸›ã¨ã‚¹ã‚¿ã‚¤ãƒ«çµ±ä¸€ã‚’å®Ÿç¾ã€‚
  * **ãƒãƒ«ãƒã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³**: æ¤œç´¢å¯¾è±¡ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚µã‚¤ãƒ‰ãƒãƒ¼ã§é¸æŠå¯èƒ½ã€‚
  * **ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°**: æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ã‚’ `st.expander` å†…ã«é€æ¬¡è¡¨ç¤ºã€‚

#### `log_viewer_page.py` (æœªå›ç­”ãƒ­ã‚°)

* **æ©Ÿèƒ½**: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã€Œå›ç­”ãªã—ã€ã¨åˆ¤æ–­ã—ãŸã‚¯ã‚¨ãƒªã®å±¥æ­´ã‚’è¡¨ç¤ºãƒ»åˆ†æã€‚

---

## 6. ãƒ¡ãƒ‹ãƒ¥ãƒ¼å˜ä½ã®å‡¦ç†æ¦‚è¦ãƒ»å‡¦ç†æ–¹å¼

### 6.1 ğŸ“– èª¬æ˜

ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®æ¦‚è¦ã‚’è¡¨ç¤ºã€‚

### 6.2 ğŸ¤– ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå¯¾è©±

ReActã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã«å¯¾ã—ã€ãƒ„ãƒ¼ãƒ«ï¼ˆæ¤œç´¢ï¼‰ã‚’ä½¿ã£ã¦å›ç­”ã‚’ä½œæˆã—ã¾ã™ã€‚

* **æ€è€ƒã®å¯è¦–åŒ–**: ã€Œãªãœãã®æ¤œç´¢ã‚’è¡Œã†ã‹ã€ã¨ã„ã†æ¨è«–éç¨‹ã‚’è¡¨ç¤ºã€‚
* **ãƒ„ãƒ¼ãƒ«åˆ©ç”¨**: `search_rag_knowledge_base` ã‚’è‡ªå¾‹çš„ã«å‘¼ã³å‡ºã—ã€Qdrantã‹ã‚‰æƒ…å ±ã‚’å–å¾—ã€‚
* **Reflection (æ¨æ•²)**: å›ç­”æ¡ˆã‚’ä½œæˆã—ãŸå¾Œã€è‡ªå·±è©•ä¾¡ãƒ•ã‚§ãƒ¼ã‚ºã‚’å®Ÿè¡Œã€‚æ­£ç¢ºæ€§ãƒ»é©åˆ‡æ€§ãƒ»ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ¨æ•²ã—ã€ã‚ˆã‚Šæ´—ç·´ã•ã‚ŒãŸå›ç­”ã‚’æç¤ºã—ã¾ã™ã€‚

---

## 9. ReAct + Reflection ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè©³ç´°è¨­è¨ˆ

æœ¬ã‚·ã‚¹ãƒ†ãƒ ã®ä¸­æ ¸ã§ã‚ã‚‹ã€Œãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒ»ãƒŠãƒ¬ãƒƒã‚¸ãƒ»ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã€ã®è©³ç´°è¨­è¨ˆã§ã™ã€‚
å‚è€ƒ: `doc/11_agent_react.md`

### 9.1 ReAct + Reflection ã®ä»•çµ„ã¿

![react_reflection](doc/assets/agent_4_react_reflection.png)

Geminiã® Function Calling æ©Ÿèƒ½ã‚’åˆ©ç”¨ã—ã€ä»¥ä¸‹ã®ã‚µã‚¤ã‚¯ãƒ«ã‚’å›ã—ã¾ã™ã€‚
![ReAct_fig](doc/assets/agent_5_react.png)

1. **ReAct ãƒ•ã‚§ãƒ¼ã‚º (è§£æ±º)**:

   * **Thought (æ€è€ƒ)**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã«å¯¾ã—ã€å¤–éƒ¨çŸ¥è­˜ãŒå¿…è¦ã‹ã€ã©ã®ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã†ã¹ãã‹è€ƒãˆã‚‹ã€‚
   * **Action (è¡Œå‹•)**: ãƒ„ãƒ¼ãƒ« (`search_rag_knowledge_base`) ã‚’å‘¼ã³å‡ºã™ã“ã¨ã‚’æ±ºå®šã—ã€APIã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã€‚
   * **Observation (è¦³å¯Ÿ)**: ãƒ„ãƒ¼ãƒ«ã‚’å®Ÿè¡Œã—ã€ãã®çµæœï¼ˆæ¤œç´¢çµæœã‚„ã‚¨ãƒ©ãƒ¼ï¼‰ã‚’å–å¾—ã€‚
   * **Draft Answer (ãƒ‰ãƒ©ãƒ•ãƒˆä½œæˆ)**: è¦³å¯Ÿçµæœã«åŸºã¥ãã€å›ç­”æ¡ˆã‚’ç”Ÿæˆã€‚

![reflection_fig](doc/assets/agent_7_reflection.png)
2. **Reflection ãƒ•ã‚§ãƒ¼ã‚º (æ¨æ•²)**:

* **Critique (æ‰¹è©•)**: ç”Ÿæˆã•ã‚ŒãŸãƒ‰ãƒ©ãƒ•ãƒˆå›ç­”ã«å¯¾ã—ã€æ¤œç´¢çµæœï¼ˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼‰ã¨ã®æ•´åˆæ€§ã‚„ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è‡ªå·±è©•ä¾¡ã€‚
* **Revise (ä¿®æ­£)**: å¿…è¦ã«å¿œã˜ã¦å›ç­”ã‚’ä¿®æ­£ã—ã€æœ€çµ‚å›ç­” (Final Answer) ã¨ã™ã‚‹ã€‚

### 9.2 ä¸»è¦ã‚¯ãƒ©ã‚¹ãƒ»é–¢æ•° IPO å®šç¾©

#### `ui.pages.agent_chat_page.run_agent_turn`

![query_fig](doc/assets/agent_6_query.png)
ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®1ã‚¿ãƒ¼ãƒ³ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç™ºè©±ã€œæœ€çµ‚å›ç­”ï¼‰ã‚’åˆ¶å¾¡ã™ã‚‹ãƒ¡ã‚¤ãƒ³é–¢æ•°ã€‚


| é …ç›®        | å†…å®¹                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| ----------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Input**   | `chat_session`: Gemini ChatSession<br>`user_input`: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•æ–‡å­—åˆ—                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **Process** | 1.`chat_session.send_message(user_input)` ã‚’é€ä¿¡ã€‚<br>2. å¿œç­”ã« `function_call` ãŒå«ã¾ã‚Œã‚‹ã‹ç¢ºèªã€‚<br>3. **å«ã¾ã‚Œã‚‹å ´åˆ**:<br>ã€€a. æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ã‚’è¡¨ç¤ºãƒ»ãƒ­ã‚°è¨˜éŒ²ã€‚<br>ã€€b. `agent_tools` å†…ã®å¯¾å¿œé–¢æ•°ã‚’å®Ÿè¡Œã€‚<br>ã€€c. çµæœã‚’ `function_response` ã¨ã—ã¦ Gemini ã«è¿”é€ã€‚<br>ã€€d. ã‚¹ãƒ†ãƒƒãƒ—2ã«æˆ»ã‚‹ï¼ˆReActãƒ«ãƒ¼ãƒ—ï¼‰ã€‚<br>4. **å«ã¾ã‚Œãªã„å ´åˆ**:<br>ã€€a. ç¾åœ¨ã®å›ç­”ã‚’ãƒ‰ãƒ©ãƒ•ãƒˆ (Draft Answer) ã¨ã™ã‚‹ã€‚<br>5. **Reflection (æ¨æ•²)**:<br>ã€€a. ãƒ‰ãƒ©ãƒ•ãƒˆå›ç­”ã‚’ `REFLECTION_INSTRUCTION` ã¨å…±ã«é€ä¿¡ã€‚<br>ã€€b. è‡ªå·±è©•ä¾¡çµæœã«åŸºã¥ãã€æœ€çµ‚å›ç­” (Final Answer) ã‚’æŠ½å‡ºã€‚ |
| **Output**  | `final_response_text`: æœ€çµ‚çš„ãªå›ç­”æ–‡å­—åˆ—                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |

#### `agent_tools.search_rag_knowledge_base`

RAGæ¤œç´¢ã‚’å®Ÿè¡Œã™ã‚‹ãƒ„ãƒ¼ãƒ«é–¢æ•°ã€‚


| é …ç›®        | å†…å®¹                                                                                                                                                                                                                                                                                                    |
| ----------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Input**   | `query`: æ¤œç´¢ã‚¯ã‚¨ãƒª<br>`collection_name`: æ¤œç´¢å¯¾è±¡ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å (Optional)                                                                                                                                                                                                                             |
| **Process** | 1. Qdrantãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã€‚<br>2. `collection_name` ã®å­˜åœ¨ç¢ºèªã€‚<br>3. `embed_query` ã§ã‚¯ã‚¨ãƒªã‚’ãƒ™ã‚¯ãƒˆãƒ«åŒ– (Gemini Embedding)ã€‚<br>4. `search_collection` ã§ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã€‚<br>5. ã‚¹ã‚³ã‚¢é–¾å€¤ (`AgentConfig.RAG_SCORE_THRESHOLD`) ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã€‚<br>6. æ¤œç´¢çµæœã‚’ LLM ãŒç†è§£ã—ã‚„ã™ã„ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã«æ•´å½¢ã€‚ |
| **Output**  | æ•´å½¢ã•ã‚ŒãŸæ¤œç´¢çµæœæ–‡å­—åˆ— (ã¾ãŸã¯`[[NO_RAG_RESULT]]`)                                                                                                                                                                                                                                                    |

# Gemini Hybrid RAG Agent - ç†è«–ã¨å®Ÿè£…ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹

æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€ReAct + Reflection ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ç†è«–çš„èƒŒæ™¯ï¼ˆæ¦‚å¿µå›³ï¼‰ã¨ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠå¯èƒ½ãªGeminiãƒ¢ãƒ‡ãƒ«ã‚’æ´»ç”¨ã—ãŸ`agent_rag.py` ãŠã‚ˆã³é–¢é€£ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å®Ÿè£…è©³ç´°ã‚’ä½“ç³»çš„ã«ã¾ã¨ã‚ãŸãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã§ã™ã€‚

---

## ç¬¬2éƒ¨: ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚å¿µ (Theoretical Architecture)

Gemini ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ã¯ã€å¤§ãã2ã¤ã®ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆè§£æ±ºã¨æ¨æ•²ï¼‰ã§æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ã€‚

## 2.1 Phase 1: ReAct (è©¦è¡ŒéŒ¯èª¤ã«ã‚ˆã‚‹è§£æ±º)

ReActã¯ã€**ã€Œè€ƒãˆï¼ˆReasoningï¼‰ã€ãªãŒã‚‰ã€Œè¡Œå‹•ï¼ˆActingï¼‰ã€ã—ã€ãã®çµæœã‚’è¦‹ã¦ã¾ãŸã€Œè€ƒãˆã‚‹ã€**ã¨ã„ã†ãƒ—ãƒ­ã‚»ã‚¹ã§ã™ã€‚
AIã¯å˜ã«å›ç­”ã‚’å‡ºåŠ›ã™ã‚‹ã®ã§ã¯ãªãã€å¤–éƒ¨ãƒ„ãƒ¼ãƒ«ï¼ˆæ¤œç´¢ãªã©ï¼‰ã‚’ä½¿ã„ãªãŒã‚‰ã€æƒ…å ±ãŒæƒã†ã¾ã§è¡Œå‹•ã‚’ç¹°ã‚Šè¿”ã—ã¾ã™ã€‚

```mermaid
flowchart LR
    Start([ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¾é ¼]) --> Thought1
    subgraph ReAct_Loop [ReActãƒ«ãƒ¼ãƒ—: è§£æ±ºãƒ‘ãƒ¼ãƒˆ]
        Thought1[Thought: ä½•ãŒå¿…è¦ã‹è€ƒãˆã‚‹] --> Action[Action: ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œ/æ¤œç´¢]
        Action --> Observation[Observation: çµæœã‚’è¦³å¯Ÿ]
        Observation --> Decision{æƒ…å ±ååˆ†?}
        Decision -- No --> Thought1
    end
    Decision -- Yes --> FinalAns[Draft Answer: å›ç­”æ¡ˆã®ç”Ÿæˆ]
```

* **Thought**: ç¾åœ¨ã®çŠ¶æ…‹ã‚’åˆ†æã—ã€æ¬¡ã«ä½•ã‚’ã™ã¹ãã‹è¨ˆç”»ã—ã¾ã™ã€‚
* **Action**: ãƒ„ãƒ¼ãƒ«ï¼ˆæ¤œç´¢ï¼‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
* **Observation**: ãƒ„ãƒ¼ãƒ«ã®å®Ÿè¡Œçµæœï¼ˆæ¤œç´¢çµæœï¼‰ã‚’å—ã‘å–ã‚Šã¾ã™ã€‚

## 2.1.1 å…¥åŠ›æ–‡å­—åˆ—ã‹ã‚‰æ¤œç´¢ã‚¯ã‚¨ãƒªç”Ÿæˆã¾ã§ã®å‡¦ç†æ§‹é€ ï¼ˆé‡è¦ï¼‰

Pythonã‚³ãƒ¼ãƒ‰å´ã§ã€Œã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡ºã€ã‚„ã€Œã‚¯ã‚¨ãƒªæ•´å½¢ã€ã‚’è¡Œã†å°‚ç”¨ã®é–¢æ•°ã¯å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
Geminiãƒ¢ãƒ‡ãƒ«è‡ªä½“ãŒã€ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æŒ‡ç¤ºã«åŸºã¥ãã€ã€Œå…¥åŠ›æ–‡ã€ã‚’è§£é‡ˆã—ã€ã€Œæœ€é©ãªæ¤œç´¢ã‚¯ã‚¨ãƒªã€ã¸ã¨å¤‰æ›ï¼ˆæ¨è«–ï¼‰ ã—ã¦ã„ã¾ã™ã€‚

1. å…¥åŠ›ãƒ•ã‚§ãƒ¼ã‚º (Pythonã‚³ãƒ¼ãƒ‰: `ui/pages/agent_chat_page.py`)

* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¡Œå‹•:
  ãƒãƒ£ãƒƒãƒˆç”»é¢ã«è‡ªç„¶æ–‡ã§è³ªå•ã‚’å…¥åŠ›ã—ã¾ã™ã€‚

  > å…·ä½“ä¾‹: ã€Œå®Ÿé¨“ç”Ÿç‰©å­¦ã§ã¯ã€ç”Ÿç‰©ã®æ©Ÿæ§‹ã‚’è§£æ˜ã™ã‚‹ãŸã‚ã«ã©ã®ã‚ˆã†ãªæ“ä½œã‚’åŠ ãˆã¾ã™ã‹ï¼Ÿã€
  >
* ã‚³ãƒ¼ãƒ‰å‡¦ç† (`run_agent_turn` é–¢æ•°):
  ã“ã®æ–‡å­—åˆ—ã¯ãã®ã¾ã¾ Gemini API (chat_session.send_message) ã«æ¸¡ã•ã‚Œã¾ã™ã€‚
  åŒæ™‚ã«ã€ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ (SYSTEM_INSTRUCTION_TEMPLATE) ã«ã‚ˆã£ã¦ã€ãƒ¢ãƒ‡ãƒ«ã«ã¯ä»¥ä¸‹ã®ã€Œæ€è€ƒã®ãƒ«ãƒ¼ãƒ«ã€ãŒä¸ãˆã‚‰ã‚Œã¦ã„ã¾ã™ã€‚

  > æŒ‡ç¤º: ã€ŒThought: [ãªãœæ¤œç´¢ãŒå¿…è¦ã‹ã€ã©ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã€ã©ã‚“ãªã‚¯ã‚¨ãƒªã§æ¤œç´¢ã™ã‚‹ã‹]ã€
  >

2. ç”Ÿæˆãƒ»æ¨è«–ãƒ•ã‚§ãƒ¼ã‚º (Gemini API å†…éƒ¨)

* ãƒ¢ãƒ‡ãƒ«ã®æ€è€ƒ (Reasoning):
  ãƒ¢ãƒ‡ãƒ«ã¯ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æŒ‡ç¤ºã«å¾“ã„ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ„å›³ã‚’æ±²ã¿å–ã‚Šã¤ã¤ã€æ¤œç´¢ãƒ„ãƒ¼ãƒ« (search_rag_knowledge_base)
  ã«æ¸¡ã™ã¹ãæœ€é©ãªå¼•æ•°ã‚’è€ƒãˆã¾ã™ã€‚

  > æ€è€ƒä¾‹: ã€Œã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã¯é•·ã„ã€‚Qdrantã§æ­£ç¢ºã«æ¤œç´¢ã™ã‚‹ã«ã¯ã€åŠ©è©ã‚’çœã„ã¦é‡è¦ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«çµã£ãŸã»ã†ãŒè‰¯ã„ã ã‚ã†ã€‚ã€
  >
* ã‚¯ã‚¨ãƒªã®æ±ºå®š (Function Call ç”Ÿæˆ):
  ãƒ¢ãƒ‡ãƒ«ã¯æ€è€ƒã®çµæœã«åŸºã¥ãã€ãƒ„ãƒ¼ãƒ«ã®å¼•æ•° query ã‚’ç”Ÿæˆã—ã¾ã™ã€‚ã“ã“ã§ã®å‡ºåŠ›ãŒã€å®Ÿéš›ã®æ¤œç´¢ã‚¯ã‚¨ãƒªã¨ãªã‚Šã¾ã™ã€‚

  > ç”Ÿæˆãƒ‘ã‚¿ãƒ¼ãƒ³ä¾‹:
  > ã‚±ãƒ¼ã‚¹A (é‡è¦èªæŠ½å‡º)*: "å®Ÿé¨“ç”Ÿç‰©å­¦ ç”Ÿç‰©ã®æ©Ÿæ§‹ æ“ä½œ"
  > ã‚±ãƒ¼ã‚¹B (ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åŒ–)*: "å®Ÿé¨“ç”Ÿç‰©å­¦ å®Ÿé¨“æ“ä½œ"
  > ã‚±ãƒ¼ã‚¹C (ãã®ã¾ã¾)*: "å®Ÿé¨“ç”Ÿç‰©å­¦ã§ã¯ã€ç”Ÿç‰©ã®æ©Ÿæ§‹ã‚’è§£æ˜ã™ã‚‹ãŸã‚ã«ã©ã®ã‚ˆã†ãªæ“ä½œã‚’åŠ ãˆã¾ã™ã‹ï¼Ÿ"
  >

â€»ç¾çŠ¶ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ã¯ã€Œã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ã¿ã«ã›ã‚ˆã€ã¨ã„ã†å¼·åˆ¶ã¯ãªã„ãŸã‚ã€ãƒ¢ãƒ‡ãƒ«ã®æ–‡è„ˆåˆ¤æ–­ã«ã‚ˆã‚Šã‚±ãƒ¼ã‚¹Aï½Cã®ã‚ˆã†ã«å¤‰å‹•ã—ã¾ã™ã€‚ã—ã‹ã—ã€Geminã¯ä¸€èˆ¬çš„ã«ã€æ¤œç´¢ã«é©ã—ãŸå½¢ï¼ˆã‚±ãƒ¼ã‚¹Aã‚„Bï¼‰ã¸è‡ªç™ºçš„ã«å¤‰æ›ã™ã‚‹å‚¾å‘ãŒã‚ã‚Šã¾ã™ã€‚

3. ä¼é”ãƒ»å®Ÿè¡Œãƒ•ã‚§ãƒ¼ã‚º (Pythonã‚³ãƒ¼ãƒ‰: `agent_tools.py`)

* ã‚³ãƒ¼ãƒ‰å‡¦ç† (`run_agent_turn` -> `search_rag_knowledge_base`):
  Gemini API ã‹ã‚‰è¿”ã£ã¦ããŸ function_call æƒ…å ±ï¼ˆãƒ¢ãƒ‡ãƒ«ãŒæ±ºã‚ãŸã‚¯ã‚¨ãƒªï¼‰ã‚’ Python å´ã§å—ã‘å–ã‚Šã€ãã®ã¾ã¾æ¤œç´¢é–¢æ•°ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```python
# agent_tools.py
def search_rag_knowledge_base(query: str, ...):
    # ã“ã“ã«æ¥ã‚‹æ™‚ç‚¹ã§ã€query ã¯æ—¢ã«ãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã£ã¦
    # "å®Ÿé¨“ç”Ÿç‰©å­¦ å®Ÿé¨“æ“ä½œ" ãªã©ã«å¤‰æ›ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
    return qdrant_service.search_collection_rag(query, ...)
```

ã¾ã¨ã‚


| ãƒ•ã‚§ãƒ¼ã‚º | æ‹…å½“               | å‡¦ç†å†…å®¹                                 | å…·ä½“ä¾‹                                  |
| :------- | :----------------- | :--------------------------------------- | :-------------------------------------- |
| 1. å…¥åŠ›  | agent_chat_page.py | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è‡ªç„¶æ–‡ã‚’å—ã‘å–ã‚‹               | ã€Œå®Ÿé¨“ç”Ÿç‰©å­¦ã§ã¯...æ“ä½œã‚’åŠ ãˆã¾ã™ã‹ï¼Ÿã€ |
| 2. å¤‰æ›  | Gemini (LLM)       | æ–‡è„ˆã‹ã‚‰ã€Œæ¤œç´¢ç”¨ã‚¯ã‚¨ãƒªã€ã‚’æ¨è«–ãƒ»ç”Ÿæˆã™ã‚‹ | ã€Œå®Ÿé¨“ç”Ÿç‰©å­¦ å®Ÿé¨“æ“ä½œã€ (ã‚±ãƒ¼ã‚¹B)       |
| 3. å®Ÿè¡Œ  | agent_tools.py     | ç”Ÿæˆã•ã‚ŒãŸã‚¯ã‚¨ãƒªã§æ¤œç´¢ã‚’å®Ÿè¡Œã™ã‚‹         | query="å®Ÿé¨“ç”Ÿç‰©å­¦ å®Ÿé¨“æ“ä½œ" ã§æ¤œç´¢      |

ã¤ã¾ã‚Šã€ã€Œã‚¯ã‚¨ãƒªç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã€ã®å®Ÿä½“ã¯ Python ã‚³ãƒ¼ãƒ‰ã§ã¯ãªãã€LLM ã®é ­è„³ï¼ˆæ¨è«–ãƒ—ãƒ­ã‚»ã‚¹ï¼‰ã®ä¸­ ã«ã‚ã‚Šã¾ã™ã€‚

### 2.1.2 CoT (Chain of Thought) ã®å‡¦ç†æ§‹é€ ï¼ˆé‡è¦ï¼‰

ReActã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€æœ€çµ‚çš„ãªå›ç­”ã‚’å‡ºã™å‰ã«ã€æ€è€ƒ(Thought)ã¨è¡Œå‹•(Action/Tool Call)ã‚’é€£é–ã•ã›ã€è«–ç†çš„ã«ç­”ãˆã‚’å°ãå‡ºã—ã¾ã™ã€‚
ä»¥ä¸‹ã¯ã€å®Ÿéš›ã®å®Ÿè¡Œãƒ­ã‚°ã«åŸºã¥ãæ€è€ƒã®é€£é–ãƒ—ãƒ­ã‚»ã‚¹ã§ã™ã€‚

![cot_fig](doc/assets/agent_8_cot_cycle.png)

#### å…·ä½“çš„ãªæŒ™å‹•ã®ä»•çµ„ã¿ (å®Ÿè¡Œãƒ­ã‚°ã®è¿½è·¡)

1. **åˆæœŸæ€è€ƒ (Initial Thought)**

   * **å…¥åŠ›**: ã€Œå®Ÿé¨“ç”Ÿç‰©å­¦ã§ã¯ã€ç”Ÿç‰©ã®æ©Ÿæ§‹ã‚’è§£æ˜ã™ã‚‹ãŸã‚ã«ã©ã®ã‚ˆã†ãªæ“ä½œã‚’åŠ ãˆã¾ã™ã‹ï¼Ÿã€
   * **LLMã®æ¨è«–**: è³ªå•ã®æ„å›³ã‚’ç†è§£ã—ã€å¤–éƒ¨æƒ…å ±ãŒå¿…è¦ã‹åˆ¤æ–­ã—ã¾ã™ã€‚
   * **æ€è€ƒãƒ­ã‚°**:
     > ğŸ§  Thought: [ç”Ÿç‰©ã®æ©Ÿæ§‹ã‚’è§£æ˜ã™ã‚‹ãŸã‚ã®æ“ä½œã«é–¢ã™ã‚‹è³ªå•ãªã®ã§ã€ä¸€èˆ¬çš„ãªçŸ¥è­˜ã¨ã—ã¦wikipediaã‚’æ¤œç´¢ã—ã¦ã¿ã‚‹ã€‚]
     >
2. **ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œ (Action & Observation)**

   * **LLMã®è¡Œå‹•**: æ¨è«–ã«åŸºã¥ãã€é©åˆ‡ãªãƒ„ãƒ¼ãƒ«ã¨å¼•æ•°ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
   * **ãƒ„ãƒ¼ãƒ«å‘¼ã³å‡ºã—**:
     > ğŸ› ï¸ Tool Call: `search_rag_knowledge_base`
     > Args: `{'collection_name': 'wikipedia_ja', 'query': 'å®Ÿé¨“ç”Ÿç‰©å­¦\u3000ç”Ÿç‰©æ©Ÿæ§‹\u3000æ“ä½œ'}`
     >
   * **ãƒ„ãƒ¼ãƒ«ã®çµæœ (Observation)**:
     > ğŸ“ Tool Result: Result 1 (Score: 0.50): Q: å®Ÿé¨“ç”Ÿç‰©å­¦ã§ã¯... A: äººç‚ºçš„ã«æ“ä½œã‚’åŠ ãˆé€šå¸¸ã¨ç•°ãªã‚‹æ¡ä»¶ã‚’ä½œã‚Šå‡ºã—...
     >
3. **è§£æ±ºæ€è€ƒ (Reasoning & Draft)**

   * **LLMã®æ¨è«–**: æ¤œç´¢çµæœã‚’èª­ã¿ã€è³ªå•ã«ç­”ãˆã‚‰ã‚Œã‚‹ã‹åˆ¤æ–­ã—ã¾ã™ã€‚
   * **æ€è€ƒãƒ­ã‚°**:
     > ğŸ§  Thought: [æ¤œç´¢çµæœã‹ã‚‰ã€è³ªå•ã«å¯¾ã™ã‚‹å›ç­”ãŒå¾—ã‚‰ã‚ŒãŸã€‚]
     >
   * **ãƒ‰ãƒ©ãƒ•ãƒˆå›ç­”**:
     > Answer: ç¤¾å†…ãƒŠãƒ¬ãƒƒã‚¸ã«ã‚ˆã‚‹ã¨ã€å®Ÿé¨“ç”Ÿç‰©å­¦ã§ã¯...
     >
4. **æ¨æ•² (Reflection)**

   * **LLMã®è‡ªå·±è©•ä¾¡**:
     > ğŸ¤” Reflection Thought: ** [è‡ªå·±è©•ä¾¡: å›ç­”ã¯è³ªå•ã«ç›´æ¥çš„ã‹ã¤æ˜ç¢ºã«ç­”ãˆã¦ãŠã‚Š...ä¿®æ­£ã¯ä¸è¦ã¨åˆ¤æ–­ã—ã¾ã—ãŸã€‚]**
     >

#### ã¾ã¨ã‚


| ã‚¹ãƒ†ãƒƒãƒ— | ãƒ•ã‚§ãƒ¼ã‚º        | å‡¦ç†å†…å®¹                 | å®Ÿéš›ã®ãƒ­ã‚°è¦ç´                                |
| :------- | :-------------- | :----------------------- | :------------------------------------------- |
| **1**    | **Thought**     | æ¤œç´¢ã®å¿…è¦æ€§ã¨æˆ¦ç•¥ã®ç«‹æ¡ˆ | `Thought: ...wikipediaã‚’æ¤œç´¢ã—ã¦ã¿ã‚‹ã€‚`      |
| **2**    | **Action**      | æ¤œç´¢ãƒ„ãƒ¼ãƒ«ã®å®Ÿè¡Œ         | `Tool Call: search_rag_knowledge_base`       |
| **3**    | **Observation** | æ¤œç´¢çµæœã®å–å¾—           | `Tool Result: ...äººç‚ºçš„ã«æ“ä½œã‚’åŠ ãˆ...`      |
| **4**    | **Draft**       | æƒ…å ±ã®çµ±åˆã¨å›ç­”ä½œæˆ     | `Answer: ç¤¾å†…ãƒŠãƒ¬ãƒƒã‚¸ã«ã‚ˆã‚‹ã¨...`            |
| **5**    | **Reflection**  | å›ç­”ã®å“è³ªãƒã‚§ãƒƒã‚¯       | `Reflection Thought: ...ä¿®æ­£ã¯ä¸è¦ã¨åˆ¤æ–­...` |

### 2.1.3 Reflectionãƒ•ã‚§ãƒ¼ã‚º (è‡ªå·±çœå¯Ÿã¨æ¨æ•²) ã®å‡¦ç†æ§‹é€ ï¼ˆé‡è¦ï¼‰

æ¤œç´¢çµæœã‚’åŸºã«ä¸€åº¦å›ç­”ã‚’ä½œæˆã—ãŸå¾Œã€ã•ã‚‰ã«ã€Œæ¨æ•²ã€ã‚’è¡Œã†ãƒ—ãƒ­ã‚»ã‚¹ã§ã™ã€‚
ã“ã‚Œã«ã‚ˆã‚Šã€å›ç­”ã®æ­£ç¢ºæ€§ã‚„ã‚¹ã‚¿ã‚¤ãƒ«ãŒã€ã‚·ã‚¹ãƒ†ãƒ è¦ä»¶ï¼ˆä¸å¯§ãªæ—¥æœ¬èªãªã©ï¼‰ã«åˆè‡´ã—ã¦ã„ã‚‹ã‹è‡ªå·±è©•ä¾¡ã—ã€å¿…è¦ã«å¿œã˜ã¦ä¿®æ­£ã—ã¾ã™ã€‚

#### ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæˆ¦ç•¥ (`REFLECTION_INSTRUCTION`)

`REFLECTION_INSTRUCTION` å®šæ•°ã«ã¦ã€ä»¥ä¸‹ã®è¦³ç‚¹ã§ã®ãƒã‚§ãƒƒã‚¯ã‚’æŒ‡ç¤ºã—ã¦ã„ã¾ã™ã€‚

1. **æ­£ç¢ºæ€§ (Accuracy)**: æ¤œç´¢çµæœã«åŸºã¥ã„ã¦ã„ã‚‹ã‹ï¼Ÿ å¹»è¦š (Hallucination) ã¯ãªã„ã‹ï¼Ÿ
2. **é©åˆ‡æ€§ (Relevance)**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã«ç›´æ¥ç­”ãˆã¦ã„ã‚‹ã‹ï¼Ÿ
3. **ã‚¹ã‚¿ã‚¤ãƒ« (Style)**: è¦ªã—ã¿ã‚„ã™ãä¸å¯§ãªæ—¥æœ¬èªï¼ˆã§ã™ãƒ»ã¾ã™èª¿ï¼‰ã‹ï¼Ÿ ç®‡æ¡æ›¸ãç­‰ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¯é©åˆ‡ã‹ï¼Ÿ

#### å…·ä½“çš„ãªæŒ™å‹•ã®ä»•çµ„ã¿

1. **ãƒ‰ãƒ©ãƒ•ãƒˆç”Ÿæˆãƒ•ã‚§ãƒ¼ã‚º** (ReActãƒ«ãƒ¼ãƒ—çµ‚äº†å¾Œ)

   * **LLMã®æ€è€ƒ**: æ¤œç´¢çµæœï¼ˆwikipediaç­‰ï¼‰ã‹ã‚‰æƒ…å ±ã‚’å¾—ãŸã®ã§ã€å›ç­”ã‚’ä½œæˆã—ã¾ã™ã€‚
     > **æ€è€ƒä¾‹ (Thought)**: ã€Œæ¤œç´¢çµæœã‹ã‚‰ã€è³ªå•ã«å¯¾ã™ã‚‹å›ç­”ãŒå¾—ã‚‰ã‚ŒãŸã€‚ã€
     >
   * **å›ç­”æ¡ˆ (Draft)**:
     > ã€Œç¤¾å†…ãƒŠãƒ¬ãƒƒã‚¸ã«ã‚ˆã‚‹ã¨ã€å®Ÿé¨“ç”Ÿç‰©å­¦ã§ã¯ã€ç”Ÿç‰©ã«å‚™ã‚ã£ã¦ã„ã‚‹æ©Ÿæ§‹ã‚’è§£æ˜ã™ã‚‹ãŸã‚ã«ã€äººç‚ºçš„ã«æ“ä½œã‚’åŠ ãˆé€šå¸¸ã¨ç•°ãªã‚‹æ¡ä»¶ã‚’ä½œã‚Šå‡ºã—ã€ãã®å¾Œã®å¤‰åŒ–ã‚’è¦³å¯Ÿãƒ»è¦³æ¸¬ã—ã¾ã™ã€‚ä¾‹ãˆã°ã€çªç„¶å¤‰ç•°ã®èª˜ç™ºã‚„éºä¼å­å°å…¥ã€ç§»æ¤å®Ÿé¨“ãªã©ã‚’è¡Œã„ã¾ã™ã€‚ã€
     >
   * **ã‚³ãƒ¼ãƒ‰å‡¦ç† (`run_agent_turn` å¾ŒåŠ)**: ã“ã®å›ç­”æ¡ˆã‚’ä¸€æ™‚å¤‰æ•° `final_response_text` ã«ä¿æŒã—ã¾ã™ã€‚
2. **æ¨æ•²ãƒ•ã‚§ãƒ¼ã‚º** (Reflection)

   * **ã‚³ãƒ¼ãƒ‰å‡¦ç†**: `REFLECTION_INSTRUCTION` (è©•ä¾¡ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ) ã¨ãƒ‰ãƒ©ãƒ•ãƒˆå›ç­”ã‚’çµåˆã—ã€å†åº¦ Gemini ã«é€ä¿¡ã—ã¾ã™ã€‚

     > **æŒ‡ç¤º**: ã€Œä»¥ä¸‹ã®åŸºæº–ã§å®¢è¦³çš„ã«è©•ä¾¡ã—...ä¿®æ­£ã—ã¦ãã ã•ã„...æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ã¯ Thought: ã§å§‹ã‚ã¦ãã ã•ã„ã€‚ã€
     >
   * **LLMã®æ€è€ƒ (Reflection Thought)**: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å¾“ã„ã€è‡ªåˆ†ã®å›ç­”ã‚’è©•ä¾¡ã—ã¾ã™ã€‚

     > **æ€è€ƒä¾‹**: ã€Œ[è‡ªå·±è©•ä¾¡: å›ç­”ã¯è³ªå•ã«ç›´æ¥çš„ã‹ã¤æ˜ç¢ºã«ç­”ãˆã¦ãŠã‚Šã€æ­£ç¢ºæ€§ã€é©åˆ‡æ€§ã€ã‚¹ã‚¿ã‚¤ãƒ«ã«ã‚‚å•é¡Œãªã„ãŸã‚ã€ä¿®æ­£ã¯ä¸è¦ã¨åˆ¤æ–­ã—ã¾ã—ãŸã€‚]ã€
     >
   * **æœ€çµ‚å›ç­”ã®ç”Ÿæˆ (Final Answer)**: è©•ä¾¡ã«åŸºã¥ãã€æœ€çµ‚ç‰ˆã‚’å‡ºåŠ›ã—ã¾ã™ã€‚

#### ã¾ã¨ã‚


| ãƒ•ã‚§ãƒ¼ã‚º    | æ‹…å½“                 | å‡¦ç†å†…å®¹                             | å…·ä½“ä¾‹                                                 |
| :---------- | :------------------- | :----------------------------------- | :----------------------------------------------------- |
| 1. æ¨æ•²æŒ‡ç¤º | `agent_chat_page.py` | ãƒ‰ãƒ©ãƒ•ãƒˆå›ç­” + è©•ä¾¡ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é€ä¿¡  | `REFLECTION_INSTRUCTION` + ã€Œç¤¾å†…ãƒŠãƒ¬ãƒƒã‚¸ã«ã‚ˆã‚‹ã¨...ã€ |
| 2. è‡ªå·±è©•ä¾¡ | `Gemini (LLM)`       | åŸºæº–ï¼ˆæ­£ç¢ºæ€§ãƒ»ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ã«å¾“ã£ã¦è©•ä¾¡ | ã€Œè‡ªå·±è©•ä¾¡: ...ä¿®æ­£ã¯ä¸è¦ã¨åˆ¤æ–­ã—ã¾ã—ãŸã€‚ã€            |
| 3. æœ€çµ‚åŒ–   | `Gemini (LLM)`       | ä¿®æ­£ç‰ˆï¼ˆã¾ãŸã¯ãã®ã¾ã¾ï¼‰ã®å›ç­”ã‚’å‡ºåŠ› | ã€Œç¤¾å†…ãƒŠãƒ¬ãƒƒã‚¸ã«ã‚ˆã‚‹ã¨...ï¼ˆæœ€çµ‚å›ç­”ï¼‰ã€                |

### 2.2 Phase 2: Reflection (è‡ªå·±çœå¯Ÿã¨æ¨æ•²)

Reflectionã¯ã€ç”Ÿæˆã•ã‚ŒãŸå›ç­”ï¼ˆãƒ‰ãƒ©ãƒ•ãƒˆï¼‰ã«å¯¾ã—ã¦å®¢è¦³çš„ãªæ‰¹è©•ã‚’è¡Œã„ã€å“è³ªã‚’é«˜ã‚ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã§ã™ã€‚

```mermaid
flowchart LR
    R_Input([Draft Answer]) --> R_Reflect
    subgraph Reflection_Loop ["Reflectionãƒ«ãƒ¼ãƒ—: æ¨æ•²ãƒ‘ãƒ¼ãƒˆ"]
        R_Reflect["Reflect: æ‰¹è©•ãƒ»ãƒã‚§ãƒƒã‚¯"] --> R_Check("å•é¡Œãªã—?")
        R_Check -- No --> R_Revise["Revise: ä¿®æ­£ç‰ˆä½œæˆ"]
        R_Revise --> R_Reflect
    end
    R_Check -- Yes --> R_Output([Final Answer])
```

* **Reflect**: æ­£ç¢ºæ€§ã€é©åˆ‡æ€§ã€ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚
* **Revise**: å•é¡ŒãŒã‚ã‚Œã°ä¿®æ­£ã—ã€æœ€çµ‚å›ç­”ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

## 2.3 çµ±åˆãƒ¢ãƒ‡ãƒ« (ReAct + Reflection)

ã€Œå‹•ãï¼ˆActionï¼‰ã€ãƒ•ã‚§ãƒ¼ã‚ºã¨ã€Œè€ƒãˆã‚‹ï¼ˆReflectionï¼‰ã€ãƒ•ã‚§ãƒ¼ã‚ºã‚’é€£æºã•ã›ã‚‹ã“ã¨ã§ã€ã‚ˆã‚Šé«˜åº¦ãªæˆæœç‰©ã‚’ç”Ÿã¿å‡ºã—ã¾ã™ã€‚

```mermaid
flowchart TD
    User([ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¾é ¼]) --> Reasoning
    subgraph Phase1 ["Phase 1: ReAct Loop"]
        direction TB
        Reasoning["æ€è€ƒã¨è¡Œå‹•ã®ç¹°ã‚Šè¿”ã—"] --> Draft["ãƒ‰ãƒ©ãƒ•ãƒˆå›ç­”ã®ä½œæˆ"]
    end

    subgraph Phase2 ["Phase 2: Reflection Loop"]
        direction TB
        Critique["ãƒ‰ãƒ©ãƒ•ãƒˆã¨ä¾é ¼ã‚’æ¯”è¼ƒãƒ»æ‰¹è©•"] --> Revise["ä¿®æ­£ã¨æ´—ç·´"]
    end

    Draft --> Critique
    Revise --> Final([Final Answer: æœ€çµ‚å›ç­”])
```

---

# ç¬¬3éƒ¨: å®Ÿè£…è©³ç´° (Implementation Details)

ä¸Šé¢çš„ç†è«–ãŒã€å®Ÿéš›ã®Pythonã‚³ãƒ¼ãƒ‰ã§ã©ã®ã‚ˆã†ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹è§£èª¬ã—ã¾ã™ã€‚

## 2.4 ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåˆ¶å¾¡: `ui/pages/agent_chat_page.py`

ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†ã‚’è¡Œã†ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã§ã™ã€‚

* **`setup_agent(selected_collections, model_name)` é–¢æ•°**:
  * **å½¹å‰²**: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’åˆæœŸåŒ–ã—ã€`google.generativeai.GenerativeModel` ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
  * **è©³ç´°**: UIã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠã—ãŸ `model_name` ã‚’å¼•æ•°ã¨ã—ã¦å—ã‘å–ã‚Šã€ãã®ãƒ¢ãƒ‡ãƒ«åã‚’ä½¿ç”¨ã—ã¦LLMã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€åˆ©ç”¨ã™ã‚‹Geminiãƒ¢ãƒ‡ãƒ«ã‚’å‹•çš„ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

### ReActãƒ«ãƒ¼ãƒ—ã®å®Ÿè£… (`run_agent_turn`)

Gemini API ã® `function_call` æ©Ÿèƒ½ã¨ Python ã® `while` ãƒ«ãƒ¼ãƒ—ã‚’çµ„ã¿åˆã‚ã›ã¦ ReAct ã‚’å®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚

```mermaid
flowchart TD
    User([ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›]) --> Start
    subgraph Agent_Process [run_agent_turn é–¢æ•°]
        direction TB
        Start[é–‹å§‹] --> ReAct_Phase

        subgraph ReAct_Phase [Phase 1: ReAct Loopã®å®Ÿè£…]
            Think[æ€è€ƒ Thought] --> Decide{ãƒ„ãƒ¼ãƒ«å¿…è¦?}
            Decide -- Yes --> Action[è¡Œå‹•: part.function_call]
            Action --> Observe[è¦³å¯Ÿ: æ¤œç´¢çµæœå–å¾—]
            Observe --> Think
            Decide -- No --> Draft[ãƒ‰ãƒ©ãƒ•ãƒˆå›ç­”ç”Ÿæˆ]
        end

        Draft --> Reflection_Phase

        subgraph Reflection_Phase [Phase 2: Reflectionã®å®Ÿè£…]
            Review[æ¨æ•²ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé€ä¿¡] --> Critique[è‡ªå·±è©•ä¾¡ & ä¿®æ­£]
            Critique --> Finalize[æœ€çµ‚å›ç­”æŠ½å‡º]
        end
    end
    Finalize --> Output([ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å›ç­”])
```

* **ã‚³ãƒ¼ãƒ‰å¯¾å¿œ**: `run_agent_turn` é–¢æ•°å†…ã® `while turn_count < max_turns:` ãƒ«ãƒ¼ãƒ—ã€‚
* **Thoughtã®å¯è¦–åŒ–**: ãƒ¢ãƒ‡ãƒ«ãŒå‡ºåŠ›ã™ã‚‹ `Thought:` ãƒ‘ãƒ¼ãƒˆã‚’æŠ½å‡ºã—ã€Streamlit UI (`st.expander`) ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºã—ã¾ã™ã€‚

### ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­è¨ˆ

* **Router Guidelines (`SYSTEM_INSTRUCTION_TEMPLATE`)**:
  * **å½¹å‰²**: ã©ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ`wikipedia_ja`, `livedoor`, `cc_news`ï¼‰ã‚’ä½¿ã†ã¹ãã‹ã®åˆ¤æ–­åŸºæº–ã‚’æä¾›ã—ã¾ã™ã€‚
  * **å®Ÿè£…**: LLMã¯ã“ã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã«å¾“ã„ã€è‡ªå¾‹çš„ã«é©åˆ‡ãªã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¾ã™ã€‚
* **Reflection Strategy (`REFLECTION_INSTRUCTION`)**:
  * **å½¹å‰²**: ãƒ‰ãƒ©ãƒ•ãƒˆå›ç­”ã«å¯¾ã™ã‚‹è©•ä¾¡åŸºæº–ï¼ˆæ­£ç¢ºæ€§ãƒ»é©åˆ‡æ€§ãƒ»ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ã‚’å®šç¾©ã—ã¾ã™ã€‚

## 2.5 ãƒ„ãƒ¼ãƒ«å®šç¾©: `agent_tools.py`

LLM ãŒå‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã‚‹ã€Œæ‰‹è¶³ã€ã¨ãªã‚‹é–¢æ•°ç¾¤ã§ã™ã€‚

* **`search_rag_knowledge_base(query, collection_name)`**:
  * **å½¹å‰²**: æŒ‡å®šã•ã‚ŒãŸã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«å¯¾ã—ã¦æ¤œç´¢ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
  * **è©³ç´°**: `services.qdrant_service.search_collection_rag` ã‚’ãƒ©ãƒƒãƒ—ã—ã€LLMãŒä½¿ã„ã‚„ã™ã„ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚
* **`list_rag_collections()`**:
  * **å½¹å‰²**: ç¾åœ¨åˆ©ç”¨å¯èƒ½ãªã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ä¸€è¦§ã‚’è¿”ã—ã¾ã™ã€‚

## 2.6 çŸ¥è­˜ãƒ™ãƒ¼ã‚¹æ¤œç´¢: `services/qdrant_service.py`

Qdrant ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã®å¯¾è©±ã€Embedding ç”Ÿæˆã€ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ã‚’æ‹…å½“ã™ã‚‹ã‚³ã‚¢ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ã™ã€‚

### Embedding (ãƒ™ã‚¯ãƒˆãƒ«åŒ–) ã®æ§‹æˆ

`helper_embedding.py` ã«é›†ç´„ã•ã‚Œã€æŠ½è±¡åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚


| é …ç›®               | è©³ç´°                                                                                                                                                |
| :----------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------- |
| **æŠ½è±¡åŸºåº•ã‚¯ãƒ©ã‚¹** | `EmbeddingClient`                                                                                                                                   |
| **å®Ÿè£…ã‚¯ãƒ©ã‚¹**     | 1.**`GeminiEmbedding`**: Gemini API (`models.embed_content`) ã‚’ä½¿ç”¨ã€‚ç¾åœ¨ã®ä¸»åŠ›ã€‚<br>2. **`OpenAIEmbedding`**: OpenAI API ã‚’ä½¿ç”¨ã€‚ãƒ¬ã‚¬ã‚·ãƒ¼/äº’æ›ç”¨ã€‚ |
| **ãƒ•ã‚¡ã‚¯ãƒˆãƒªé–¢æ•°** | `create_embedding_client(provider="gemini", ...)`                                                                                                   |

### æ¤œç´¢ãƒ­ã‚¸ãƒƒã‚¯ (Hybrid Search)

Qdrant ã® **Hybrid RAG (Dense + Sparse)** æ©Ÿèƒ½ã‚’æ´»ç”¨ã—ã¦ã„ã¾ã™ã€‚


| å‡¦ç†ãƒ•ã‚§ãƒ¼ã‚º       | ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« / é–¢æ•°                                             | è©³ç´° (Input / Process / Output)                                                                                                                                                                 |
| :----------------- | :------------------------------------------------------------ | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **è¨­å®š (Setup)**   | `qdrant_client_wrapper.py`<br>`create_or_recreate_collection` | **Input**: `client`, `name`, `vector_size`<br>**Process**: Denseãƒ™ã‚¯ãƒˆãƒ«ã¨Sparseãƒ™ã‚¯ãƒˆãƒ«ã®ä¸¡æ–¹ã®è¨­å®šã‚’è¡Œã„ã€ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã€‚<br>**Output**: ãªã—                                            |
| **å®Ÿè¡Œ (Runtime)** | `qdrant_client_wrapper.py`<br>`search_collection`             | **Input**: `client`, `collection_name`, `query_vector`<br>**Process**: Dense (æ„å‘³æ¤œç´¢) ã¨ Sparse (ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢) ã‚’çµ„ã¿åˆã‚ã›ãŸãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ã‚’å®Ÿè¡Œã€‚<br>**Output**: é«˜ç²¾åº¦ãªæ¤œç´¢çµæœãƒªã‚¹ãƒˆ |

```mermaid
graph TD
    subgraph Python App
        Query[ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›] --> |helper_embedding.py| Embed[Embeddingç”Ÿæˆ]
        Embed --> |GeminiEmbedding| API[Gemini API]
        API --> |Vector| Embed
        Embed --> |Vector| Search[search_collection]
    end

    subgraph Qdrant DB
        Search --> |Query Vector| Engine[æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³]
        Config[Hybrid Search] -.-> Engine
        Engine --> |Dense + Sparse| Score[é¡ä¼¼åº¦ã‚¹ã‚³ã‚¢ç®—å‡º]
        Score --> |Top K Results| Search
    end
```

### 1. æ¤œæŸ»æ©Ÿèƒ½ï¼ˆæ¤œç´¢ï¼‰ã‚’å®Ÿç¾ã—ã¦ã„ã‚‹ã‚¯ãƒ©ã‚¹ãƒ»é–¢æ•°

`agent_rag.py` ã¯ã‚ãã¾ã§ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆï¼ˆç”»é¢é·ç§»ã®ç®¡ç†ï¼‰ã§ã‚ã‚Šã€å®Ÿéš›ã®æ¤œç´¢ãƒ­ã‚¸ãƒƒã‚¯ã¯ **UIå±¤** ã¨ **ã‚µãƒ¼ãƒ“ã‚¹å±¤ï¼ˆãƒ©ãƒƒãƒ‘ãƒ¼ï¼‰** ã«åˆ†é›¢ã•ã‚Œã¦ã„ã¾ã™ã€‚


| å±¤                | ãƒ•ã‚¡ã‚¤ãƒ«                         | é–¢æ•° / ã‚¯ãƒ©ã‚¹               | èª¬æ˜                                                                                                                                  |
| :---------------- | :------------------------------- | :-------------------------- | :------------------------------------------------------------------------------------------------------------------------------------ |
| **App Entry**     | `agent_rag.py`                   | `main()`                    | ç”»é¢é¸æŠãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã§ã€ŒğŸ” Qdrantæ¤œç´¢ã€ãŒé¸ã°ã‚Œã‚‹ã¨ã€ä¸‹è¨˜ã®`show_qdrant_search_page` ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚                                 |
| **UI Layer**      | `ui/pages/qdrant_search_page.py` | `show_qdrant_search_page()` | æ¤œç´¢ç”»é¢ã®ãƒ¡ã‚¤ãƒ³é–¢æ•°ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ï¼ˆã‚¯ã‚¨ãƒªã€è¨­å®šï¼‰ã‚’å—ã‘å–ã‚Šã€æ¤œç´¢å®Ÿè¡Œãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã«ä¸‹è¨˜ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚        |
| **Service Layer** | `qdrant_client_wrapper.py`       | `search_collection()`       | **æ¤œç´¢å®Ÿè¡Œã®ä¸­æ ¸é–¢æ•°ã§ã™ã€‚** Qdrantã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«å¯¾ã—ã¦ã‚¯ã‚¨ãƒªã‚’é€ä¿¡ã—ã€çµæœã‚’å—ã‘å–ã‚Šã¾ã™ã€‚ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ã®åˆ†å²ã‚‚ã“ã“ã§è¡Œã‚ã‚Œã¾ã™ã€‚ |
| **Service Layer** | `services/qdrant_service.py`     | `embed_query_for_search()`  | ã‚¯ã‚¨ãƒªæ–‡å­—åˆ—ã‚’**Dense Vector**ï¼ˆå¯†ãƒ™ã‚¯ãƒˆãƒ«ï¼‰ã«å¤‰æ›ã—ã¾ã™ï¼ˆGemini or OpenAI APIï¼‰ã€‚                                                    |

### 2. Dense + Sparse æ©Ÿèƒ½ã‚’å®Ÿç¾ã—ã¦ã„ã‚‹ã‚¯ãƒ©ã‚¹ãƒ»é–¢æ•°

ã€ŒDense + Sparseï¼ˆãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ï¼‰ã€ã¯ã€é€šå¸¸ã®ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ï¼ˆDenseï¼‰ã«åŠ ãˆã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ã«è¿‘ã„æ€§è³ªã‚’æŒã¤ **Sparse Vector** ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§å®Ÿç¾ã•ã‚Œã¦ã„ã¾ã™ã€‚


| æ©Ÿèƒ½                  | ãƒ•ã‚¡ã‚¤ãƒ«                     | é–¢æ•° / ã‚¯ãƒ©ã‚¹                                | èª¬æ˜                                                                                                                            |
| :-------------------- | :--------------------------- | :------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------ |
| **Sparse Vectorç”Ÿæˆ** | `qdrant_client_wrapper.py`   | `embed_sparse_query_unified()`               | ã‚¯ã‚¨ãƒªæ–‡å­—åˆ—ã‚’**Sparse Vector**ï¼ˆç–ãƒ™ã‚¯ãƒˆãƒ«ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰é‡ã¿ï¼‰ã«å¤‰æ›ã—ã¾ã™ã€‚å†…éƒ¨ã§ `helper_embedding_sparse.py` ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚ |
| **Hybridæ¤œç´¢å®Ÿè¡Œ**    | `qdrant_client_wrapper.py`   | `search_collection()`                        | å¼•æ•°`sparse_vector` ãŒæ¸¡ã•ã‚ŒãŸå ´åˆã€Denseã¨Sparseã®ä¸¡æ–¹ã‚’ä½¿ã£ã¦æ¤œç´¢ã—ã€**RRF (Reciprocal Rank Fusion)** ã§çµæœã‚’çµ±åˆã—ã¾ã™ã€‚    |
| **ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å®šç¾©**  | `services/qdrant_service.py` | `create_or_recreate_collection_for_qdrant()` | ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ä½œæˆæ™‚ã«ã€Denseç”¨è¨­å®šã«åŠ ãˆ`sparse_vectors_config` ã‚’è¨­å®šã—ã€ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢å¯èƒ½ãªå™¨ã‚’ç”¨æ„ã—ã¾ã™ã€‚                 |
| **ãƒã‚¤ãƒ³ãƒˆæ§‹ç¯‰**      | `services/qdrant_service.py` | `build_points_for_qdrant()`                  | ãƒ‡ãƒ¼ã‚¿ç™»éŒ²æ™‚ã«ã€Denseãƒ™ã‚¯ãƒˆãƒ«ã¨Sparseãƒ™ã‚¯ãƒˆãƒ«ã‚’ä¸€ã¤ã®`PointStruct` ã«ã¾ã¨ã‚ã¦æ ¼ç´ã™ã‚‹æ§‹é€ ã‚’ä½œã‚Šã¾ã™ã€‚                           |

### 3. æ§‹é€ ã¨å‡¦ç†ãƒ•ãƒ­ãƒ¼

ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ãŒå®Ÿè¡Œã•ã‚Œã‚‹éš›ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ã¨æ§‹é€ ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

#### A. å‡¦ç†ãƒ•ãƒ­ãƒ¼

1. **UIå…¥åŠ›**: `show_qdrant_search_page` ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œâš™ï¸ ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã€ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€æ¤œç´¢ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã€‚
2. **ãƒ™ã‚¯ãƒˆãƒ«åŒ– (Parallel)**:
   * **Dense**: `embed_query_for_search(query)` â†’ `[0.12, -0.5, ...]` (3072æ¬¡å…ƒãªã©)
   * **Sparse**: `embed_sparse_query_unified(query)` â†’ `indices=[101, 503...], values=[0.5, 0.8...]`
3. **æ¤œç´¢å®Ÿè¡Œ**: `search_collection(..., query_vector, sparse_vector)` ãŒå‘¼ã°ã‚Œã‚‹ã€‚
4. **Qdrantã‚¯ã‚¨ãƒªæ§‹ç¯‰**:
   * Denseç”¨ã¨Sparseç”¨ã®2ã¤ã® `models.Prefetch` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã€‚
   * `models.FusionQuery(fusion=models.Fusion.RRF)` ã‚’ä½¿ç”¨ã—ã¦ã€2ã¤ã®æ¤œç´¢çµæœã‚’ã‚¹ã‚³ã‚¢ãƒ™ãƒ¼ã‚¹ã§èåˆã™ã‚‹ã‚¯ã‚¨ãƒªã‚’ç™ºè¡Œã€‚
5. **çµæœè¡¨ç¤º**: çµ±åˆã•ã‚ŒãŸæ¤œç´¢çµæœï¼ˆHitsï¼‰ãŒUIã«è¿”å´ã•ã‚Œã€è¡¨ç¤ºã•ã‚Œã‚‹ã€‚

#### B. ãƒ‡ãƒ¼ã‚¿æ§‹é€  (Qdrantå†…éƒ¨)

Qdrantå†…ã§ã¯ã€1ã¤ã®ãƒã‚¤ãƒ³ãƒˆï¼ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼‰ã«å¯¾ã—ã¦ã€Œåå‰ä»˜ããƒ™ã‚¯ãƒˆãƒ« (Named Vectors)ã€ã¨ã—ã¦Denseã¨SparseãŒå…±å­˜ã—ã¦ã„ã¾ã™ã€‚

```python
# build_points_for_qdrant å†…ã§ã®æ§‹é€ ã‚¤ãƒ¡ãƒ¼ã‚¸
PointStruct(
    id=...,
    vector={
        "default": [0.1, 0.2, ...],        # Dense Vector (æ„å‘³æ¤œç´¢ç”¨)
        "text-sparse": {                   # Sparse Vector (ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒç”¨)
            "indices": [12, 505, ...],
            "values": [0.9, 0.5, ...]
        }
    },
    payload={ "question": "...", "answer": "..." }
)
```

ã“ã®æ§‹é€ ã«ã‚ˆã‚Šã€`search_collection` é–¢æ•°å†…ã§ `using="default"` ã¨ `using="text-sparse"` ã‚’æŒ‡å®šã—ã¦ãã‚Œãã‚Œã®ãƒ™ã‚¯ãƒˆãƒ«ç©ºé–“ã‚’æ¤œç´¢ã—ã€æœ€å¾Œã«ãƒãƒ¼ã‚¸ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã£ã¦ã„ã¾ã™ã€‚

## ç¬¬3éƒ¨: å‹•ä½œã‚·ãƒ¼ã‚±ãƒ³ã‚¹ (Runtime Behavior)

## 3.1 å‡¦ç†ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³

Streamlit UIã€Gemini APIã€Agent Tools é–“ã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³è©³ç´°ã§ã™ã€‚

```mermaid
sequenceDiagram
    participant UI as Agent Controller<br>(Streamlit)
    participant LLM as é¸æŠã•ã‚ŒãŸGeminiãƒ¢ãƒ‡ãƒ«
    participant Tool as Agent Tools<br>(Search/RAG)

    Note over UI, LLM: Phase 1: ReAct Loop
    UI->>LLM: send_message(ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›)
    loop è§£æ±ºã™ã‚‹ã¾ã§ç¹°ã‚Šè¿”ã—
        LLM-->>UI: å¿œç­” (Text + FunctionCall?)
        alt Function Call ã‚ã‚Š
            UI->>UI: Thoughtã‚’ãƒ­ã‚°è¡¨ç¤º
            UI->>Tool: ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œ (ä¾‹: search_rag)
            Tool-->>UI: æ¤œç´¢çµæœ (Observation)
            UI->>LLM: send_message(function_response)
        else Function Call ãªã—
            LLM-->>UI: å›ç­”æ¡ˆ (Draft Answer)
            Note over UI: ãƒ«ãƒ¼ãƒ—çµ‚äº† (break)
        end
    end
```

#### ä¸»è¦æ§‹æˆè¦ç´ 


| é …ç›®                   | å®Ÿè£…è©³ç´°                         | å½¹å‰²                                                                                     |
| :--------------------- | :------------------------------- | :--------------------------------------------------------------------------------------- |
| **ãƒ«ãƒ¼ãƒ—åˆ¶å¾¡**         | `while turn_count < max_turns:`  | æ€è€ƒãƒ»è¡Œå‹•ã‚µã‚¤ã‚¯ãƒ«ã®ç¶­æŒã¨ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ã€‚                                               |
| **ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œ**         | `part.function_call` æ¤œçŸ¥        | ãƒ¢ãƒ‡ãƒ«ãŒãƒ„ãƒ¼ãƒ«åˆ©ç”¨ã‚’è¦æ±‚ã—ãŸå ´åˆã€å¯¾å¿œã™ã‚‹ Python é–¢æ•° (`agent_tools.py`) ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ |
| **çµæœãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯** | `chat_session.send_message(...)` | ãƒ„ãƒ¼ãƒ«ã®å®Ÿè¡Œçµæœã‚’`function_response` ã¨ã—ã¦ãƒ¢ãƒ‡ãƒ«ã«è¿”ã—ã€æ¬¡ã®æ€è€ƒã‚’ä¿ƒã—ã¾ã™ã€‚           |

## 3.2 Router & Multi-turn Strategy

ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã©ã®ã‚ˆã†ã«æ¤œç´¢å¯¾è±¡ã‚’æ±ºå®šã—ã€å¤±æ•—æ™‚ã«ãƒªã‚«ãƒãƒªã™ã‚‹ã‹ã‚’ç¤ºã—ã¾ã™ã€‚

1. **Router (ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³é¸æŠ)**:
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã®å†…å®¹ã«åŸºã¥ãã€`SYSTEM_INSTRUCTION` ã®ãƒ«ãƒ¼ãƒ«ã«å¾“ã£ã¦æœ€é©ãªã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ±ºå®šã—ã¾ã™ï¼ˆä¾‹: ä¸€èˆ¬çŸ¥è­˜ãªã‚‰ `wikipedia_ja`ï¼‰ã€‚
2. **Multi-turn Strategy (ãƒªã‚«ãƒãƒª)**:
   * æ¤œç´¢çµæœãŒ `[[NO_RAG_RESULT]]` ã ã£ãŸå ´åˆã€LLM ã¯å³åº§ã«è«¦ã‚ãšã€**åˆ¥ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³**ã‚’è©¦ã—ãŸã‚Šã€**ã‚¯ã‚¨ãƒªã‚’è¨€ã„æ›ãˆ**ã¦å†æ¤œç´¢ã‚’è¡Œã„ã¾ã™ã€‚

---

# ç¬¬4éƒ¨: ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹æˆå›³ (Module Dependencies)

ã‚·ã‚¹ãƒ†ãƒ ã®å…¨ä½“çš„ãªä¾å­˜é–¢ä¿‚å›³ã§ã™ã€‚

```mermaid
graph TD
    subgraph UI_Layer [UI / Controller]
        AgentPage[agent_chat_page.py<br>Main Logic]
    end

    subgraph Service_Layer [Services & Tools]
        Tools[agent_tools.py<br>Tool Definitions]
        QdrantSvc[services/qdrant_service.py<br>DB Access]
        Config[config.py]
    end

    subgraph External_API
        Gemini[google.generativeai]
        QdrantDB[(Qdrant Vector DB)]
    end

    AgentPage --> |Import/Call| Tools
    AgentPage --> |Import/Call| QdrantSvc
    AgentPage --> |Import| Config
    AgentPage --> |API Call| Gemini
    Tools --> |Search| QdrantSvc
    QdrantSvc --> |Query| QdrantDB
```
