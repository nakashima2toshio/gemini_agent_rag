# a02_make_qa_para.py - 標準並列処理Q/A生成システム (Celery/Redis版)

作成日: 2025-11-28 (最終更新: Gemini移行対応)

## 目次

1. [概要](#1-概要)
   - [1.1 目的と位置づけ](#11-目的と位置づけ)
   - [1.2 起動コマンド](#12-起動コマンド)
   - [1.3 主要機能](#13-主要機能)
   - [1.4 対応データセット](#14-対応データセット)
   - [1.5 処理モード比較](#15-処理モード比較)
   - [1.6 関連ドキュメント](#16-関連ドキュメント)
2. [アーキテクチャ](#2-アーキテクチャ)
   - [2.1 システム構成図](#21-システム構成図)
   - [2.2 処理フロー図](#22-処理フロー図)
   - [2.3 依存モジュール](#23-依存モジュール)
   - [2.4 データセット拡張設定](#24-データセット拡張設定)
3. [キーワード抽出・複雑度分析](#3-キーワード抽出複雑度分析)
   - [3.1 KeywordExtractorクラス](#31-keywordextractorクラス)
   - [3.2 複雑度分析関数](#32-複雑度分析関数)
   - [3.3 主要概念抽出](#33-主要概念抽出)
4. [セマンティックチャンク分割](#4-セマンティックチャンク分割)
   - [4.1 チャンク作成関数](#41-チャンク作成関数)
   - [4.2 文書チャンク作成](#42-文書チャンク作成)
   - [4.3 小チャンク統合](#43-小チャンク統合)
   - [4.4 SemanticCoverageクラス詳細](#44-semanticcoverageクラス詳細)
5. [プロンプト設計](#5-プロンプト設計)
   - [5.1 2段階プロンプト構造](#51-2段階プロンプト構造)
   - [5.2 システムプロンプト設計](#52-システムプロンプト設計)
   - [5.3 ユーザープロンプト構築](#53-ユーザープロンプト構築)
   - [5.4 質問タイプ階層構造](#54-質問タイプ階層構造)
   - [5.5 動的Q/A数決定ロジック（UnifiedLLMClient利用）](#55-動的qa数決定ロジックunifiedllmclient利用)
   - [5.6 JSON出力フォーマット仕様](#56-json出力フォーマット仕様)
6. [Q/Aペア生成（UnifiedLLMClient利用）](#6-qaペア生成unifiedllmclient利用)
   - [6.1 バッチ処理](#61-バッチ処理)
   - [6.2 単一チャンク処理](#62-単一チャンク処理)
   - [6.3 データセット全体処理](#63-データセット全体処理)
7. [API呼び出し方式（Gemini API）](#7-api呼び出し方式gemini-api)
   - [7.1 構造化出力API（UnifiedLLMClient.generate_structured）](#71-構造化出力apiunifiedllmclientgeneratestructured)
   - [7.2 Pydanticモデル定義](#72-pydanticモデル定義)
8. [Celery非同期並列処理](#8-celery非同期並列処理)
   - [8.1 システム構成図](#81-システム構成図)
   - [8.2 ワーカー管理](#82-ワーカー管理)
   - [8.3 ワーカー起動・管理コマンド](#83-ワーカー起動管理コマンド)
   - [8.4 並列タスク投入・結果収集](#84-並列タスク投入結果収集)
   - [8.5 結果収集メカニズム（Redis直接アクセス）](#85-結果収集メカニズムredis直接アクセス)
   - [8.6 リトライ・エラーハンドリング](#86-リトライエラーハンドリング)
   - [8.7 主要ファイル](#87-主要ファイル)
9. [カバレージ分析](#9-カバレージ分析)
   - [9.1 データセット別最適閾値](#91-データセット別最適閾値)
   - [9.2 多段階カバレージ分析](#92-多段階カバレージ分析)
   - [9.3 チャンク特性別分析](#93-チャンク特性別分析)
   - [9.4 メイン分析関数](#94-メイン分析関数)
10. [出力とファイル保存](#10-出力とファイル保存)
    - [10.1 出力形式](#101-出力形式)
    - [10.2 ファイル命名規則](#102-ファイル命名規則)
    - [10.3 メタデータ付与](#103-メタデータ付与)
    - [10.4 保存ディレクトリ構造](#104-保存ディレクトリ構造)
11. [コマンドラインオプション](#11-コマンドラインオプション)
    - [11.1 全オプション一覧](#111-全オプション一覧)
    - [11.2 入力ソース](#112-入力ソース)
12. [実行方法](#12-実行方法)
    - [12.1 環境準備](#121-環境準備)
    - [12.2 テスト実行](#122-テスト実行)
    - [12.3 Celery並列実行](#123-celery並列実行)
    - [12.4 UIからの実行（Streamlit）](#124-uiからの実行streamlit)
    - [12.5 実行時の進捗表示](#125-実行時の進捗表示)
    - [12.6 実行時間の見積もり](#126-実行時間の見積もり)
13. [トラブルシューティング](#13-トラブルシューティング)
14. [次ステップ](#14-次ステップ)
    - [14.1 Qdrantへの登録](#141-qdrantへの登録)
    - [14.2 検索処理との連携](#142-検索処理との連携)
15. [付録](#15-付録)
    - [15.1 データ読み込み関数](#151-データ読み込み関数)
    - [15.2 コード参照一覧](#152-コード参照一覧)
16. [参考資料](#16-参考資料)

---

## 1. 概要

### 1.1 目的と位置づけ

`a02_make_qa_para.py`は、Celery + Redisを用いた**分散タスクキュー方式**によるQ/Aペア自動生成システムです。
Gemini API (`gemini-2.0-flash`等) を使用し、各ドキュメントやチャンクを個別のタスクとして管理・実行します。

> **【推奨】**
> API呼び出し回数を削減し、単一サーバーで高速に処理したい場合は、**[a10_qa_optimized_hybrid_batch.py](a10_qa_optimized_hybrid_batch.md)** の使用を推奨します。
> 本スクリプト (`a02`) は、複数のサーバーにワーカーを配置して処理を水平スケールさせたい場合や、タスク単位の厳密な状態管理が必要な場合に適しています。

### 1.2 起動コマンド

```bash
# 基本実行（同期処理）
python a02_make_qa_para.py --dataset livedoor --model gemini-2.0-flash --max-docs 20

# Celery並列処理
# Gemini APIのレート制限に合わせてワーカー数を調整（例: 8ワーカー）
python a02_make_qa_para.py --dataset cc_news --use-celery --celery-workers 8 --batch-chunks 3 --model gemini-2.0-flash
```

### 1.3 主要機能

| 機能 | 説明 |
|---|---|
| **セマンティック分割によるチャンク作成** | 段落境界を優先した意味的チャンク作成（`gemini-embedding-001`を使用した埋め込みでセマンティックな一貫性を維持） |
| **バッチ処理による並列Q/A生成** | Gemini API (`gemini-2.0-flash`等) を使用し、1-5チャンクを同時に処理してAPI呼び出しを削減 |
| **Celeryによる非同期並列処理** | 複数ワーカーでGemini APIへの呼び出しを非同期に実行し、大規模データ処理を高速化 |
| **小チャンク自動統合による効率化** | 短すぎるチャンクを自動的に統合し、Q/A生成の効率と品質を向上 |
| **動的Q/A数決定ロジック** | チャンクのトークン数や文書位置に基づいて最適なQ/A生成数を動的に調整（`UnifiedLLMClient`でトークンカウント） |
| **多段階カバレージ分析** | 生成されたQ/Aペアがドキュメントをどの程度網羅しているかを`gemini-embedding-001`で評価（strict/standard/lenient） |
| **チャンク特性別カバレージ分析** | チャンクの長さや文書内の位置に応じたカバレージ分析を提供 |

### 1.4 対応データセット

| データセット | キー | 言語 | 説明 |
|------------|------|------|------|
| CC-News | `cc_news` | 英語 | 英語ニュース記事（7,376件） |
| CC100日本語 | `japanese_text` | 日本語 | Webテキストコーパス |
| Wikipedia日本語版 | `wikipedia_ja` | 日本語 | 百科事典的知識 |
| Livedoorニュース | `livedoor` | 日本語 | ニュースコーパス（7,376件） |

### 1.5 処理モード比較

| モード | API呼び出し | 実行時間 | 効率化率 | 推奨用途 |
|--------|------------|---------|---------|---------|
| 同期処理 | 1800回 | 180分 | 1.0x | 小規模テスト |
| Celery並列 | 1800回 | 23分 | 7.8x | 中規模処理 |
| **ハイブリッド** | **600回** | **8分** | **22.5x** | **大規模処理（推奨）** |

### 1.6 関連ドキュメント

本ドキュメントは以下のドキュメント群の一部です：

| ドキュメント | 焦点 | 内容 |
|-------------|------|------|
| `doc/03_chunk.md` | チャンク分割技術 | SemanticCoverage、文分割、MeCab |
| `doc/04_prompt.md` | プロンプト設計 | 2段階構造、言語別対応、質問タイプ階層 |
| `doc/05_qa_pair.md` | 実行・処理フロー | 並列処理、Celery、出力、カバレージ |
| `doc/06_embedding_qdrant.md` |クトル化・DB登録 | Embedding、Qdrant、類似度検索 |
| **`doc/a02_make_qa_para.md`（本書）** | **実装詳細** | **a02スクリプトの全機能解説** |

---

## 2. アーキテクチャ

### 2.1 システム構成図

```mermaid
flowchart TB
    subgraph a02_make_qa_para.py[