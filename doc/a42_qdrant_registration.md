# a42_qdrant_registration.py - æŠ€è¡“ä»•æ§˜æ›¸

## ç›®æ¬¡

1. [æ¦‚è¦](#1-æ¦‚è¦)
2. [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#2-ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
3. [ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³è¨­å®š](#3-ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³è¨­å®š)
4. [ãƒ‡ãƒ¼ã‚¿å‡¦ç†æ©Ÿèƒ½](#4-ãƒ‡ãƒ¼ã‚¿å‡¦ç†æ©Ÿèƒ½)
5. [åŸ‹ã‚è¾¼ã¿ç”Ÿæˆ](#5-åŸ‹ã‚è¾¼ã¿ç”Ÿæˆ)
6. [ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³](#6-ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
7. [ä½¿ç”¨æ–¹æ³•](#7-ä½¿ç”¨æ–¹æ³•)
8. [æ¤œç´¢æ©Ÿèƒ½](#8-æ¤œç´¢æ©Ÿèƒ½)
9. [ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](#9-ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)

---

## 1. æ¦‚è¦

### 1.1 ç›®çš„

`a42_qdrant_registration.py`ã¯ã€Q&Aãƒ‡ãƒ¼ã‚¿ãŠã‚ˆã³ç”Ÿãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’Qdrantãƒ™ã‚¯ãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ç™»éŒ²ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚å„ç”Ÿæˆæ–¹å¼ï¼ˆLLMã€ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã€ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ï¼‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç‹¬ç«‹ã—ãŸã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ç®¡ç†ã—ã¾ã™ã€‚

### 1.2 å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰

```bash
# å…¨ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ï¼ˆæ¨å¥¨ï¼‰
python a42_qdrant_registration.py --recreate --include-answer

# ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ç™»éŒ²
python a42_qdrant_registration.py \
    --input-file qa_output/qa_pairs_upload_20251122_182355.csv \
    --recreate \
    --include-answer
```

### 1.3 ä¸»è¦æ©Ÿèƒ½

- **8ã¤ã®ç‹¬ç«‹ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³**: Q&A 6ç¨® + ç”Ÿãƒ†ã‚­ã‚¹ãƒˆ 2ç¨®
- **OpenAI Embedding**: text-embedding-3-smallï¼ˆ1536æ¬¡å…ƒï¼‰
- **ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ç™»éŒ²**: CSV/TXT/JSON/JSONLå¯¾å¿œ
- **è¨€èªè‡ªå‹•åˆ¤å®š**: æ—¥æœ¬èªãƒ»è‹±èªã‚’è‡ªå‹•æ¤œå‡º
- **ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒ£ãƒ³ã‚¯åˆ†å‰²**: æ®µè½â†’æ–‡å˜ä½ã§æ„å‘³ã‚’ä¿æŒ
- **ãƒãƒƒãƒå‡¦ç†å¯¾å¿œ**: ãƒˆãƒ¼ã‚¯ãƒ³æ•°ãƒ™ãƒ¼ã‚¹ã®å‹•çš„ãƒãƒƒãƒã‚µã‚¤ã‚º

### 1.4 å…¥å‡ºåŠ›

| ç¨®åˆ¥ | ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ | å½¢å¼ |
|------|------------|------|
| INPUT | qa_output/*.csv | Q&Aãƒšã‚¢ï¼ˆquestion, answerï¼‰ |
| INPUT | OUTPUT/*.txt | ç”Ÿãƒ†ã‚­ã‚¹ãƒˆ |
| INPUT | --input-file | ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆCSV/TXT/JSON/JSONLï¼‰ |
| OUTPUT | Qdrant Vector Database | ãƒ™ã‚¯ãƒˆãƒ« + ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ |

---

## 2. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### 2.1 ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆå›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  a42_qdrant_registration.py (901è¡Œ)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è¨­å®šãƒ»å®šæ•°                                                      â”‚
â”‚  â”œâ”€â”€ DEFAULTS (90-98) - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š                          â”‚
â”‚  â””â”€â”€ COLLECTION_MAPPINGS (102-167) - 8ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å®šç¾©           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è¨­å®šãƒ»ãƒ˜ãƒ«ãƒ‘ãƒ¼                                                  â”‚
â”‚  â”œâ”€â”€ load_config (171-186) - config.ymlèª­ã¿è¾¼ã¿                 â”‚
â”‚  â”œâ”€â”€ batched (189-197) - ãƒãƒƒãƒå‡¦ç†ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿                   â”‚
â”‚  â””â”€â”€ get_openai_client (200-203) - OpenAIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå–å¾—        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  åŸ‹ã‚è¾¼ã¿ç”Ÿæˆ                                                    â”‚
â”‚  â”œâ”€â”€ embed_texts_openai (206-209) - OpenAI APIå‘¼ã³å‡ºã—          â”‚
â”‚  â””â”€â”€ embed_texts (211-290) - ãƒãƒƒãƒå‡¦ç†ç‰ˆåŸ‹ã‚è¾¼ã¿ç”Ÿæˆ           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿                                                  â”‚
â”‚  â”œâ”€â”€ build_inputs (293-296) - å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆæ§‹ç¯‰                  â”‚
â”‚  â”œâ”€â”€ load_csv (299-317) - CSVãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿                   â”‚
â”‚  â”œâ”€â”€ detect_language (320-340) - è¨€èªè‡ªå‹•åˆ¤å®š                   â”‚
â”‚  â”œâ”€â”€ chunk_japanese_text (342-438) - æ—¥æœ¬èªãƒãƒ£ãƒ³ã‚¯åˆ†å‰²         â”‚
â”‚  â”œâ”€â”€ chunk_english_text (440-534) - è‹±èªãƒãƒ£ãƒ³ã‚¯åˆ†å‰²            â”‚
â”‚  â””â”€â”€ load_txt (536-573) - TXTãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Qdrantæ“ä½œ                                                      â”‚
â”‚  â”œâ”€â”€ create_or_recreate_collection (576-605) - ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ä½œæˆ  â”‚
â”‚  â”œâ”€â”€ build_points (608-652) - ãƒã‚¤ãƒ³ãƒˆæ§‹ç¯‰                      â”‚
â”‚  â”œâ”€â”€ upsert_points (654-659) - ã‚¢ãƒƒãƒ—ã‚µãƒ¼ãƒˆ                     â”‚
â”‚  â””â”€â”€ search (665-702) - æ¤œç´¢                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  main (705-900) - ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ä¾å­˜ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

```python
import argparse
import os
from datetime import datetime, timezone
from typing import Dict, Iterable, List, Optional, Any
from pathlib import Path
import pandas as pd
import yaml  # ã‚ªãƒ—ã‚·ãƒ§ãƒ³
import tiktoken

from qdrant_client import QdrantClient
from qdrant_client.http import models
from openai import OpenAI
```

---

## 3. ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³è¨­å®š

### 3.1 COLLECTION_MAPPINGSï¼ˆå…¨8ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼‰

| ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å | CSVãƒ•ã‚¡ã‚¤ãƒ« | ãƒ‰ãƒ¡ã‚¤ãƒ³ | ç”Ÿæˆæ–¹æ³• | ã‚¿ã‚¤ãƒ— |
|--------------|-----------|---------|---------|-------|
| qa_cc_news_a02_llm | qa_output/a02_qa_pairs_cc_news.csv | cc_news | a02_make_qa | qa |
| qa_cc_news_a03_rule | qa_output/a03_qa_pairs_cc_news.csv | cc_news | a03_coverage | qa |
| qa_cc_news_a10_hybrid | qa_output/a10_qa_pairs_cc_news.csv | cc_news | a10_hybrid | qa |
| qa_livedoor_a02_20_llm | qa_output/a02_qa_pairs_livedoor.csv | livedoor | a02_make_qa | qa |
| qa_livedoor_a03_rule | qa_output/a03_qa_pairs_livedoor.csv | livedoor | a03_coverage | qa |
| qa_livedoor_a10_hybrid | qa_output/a10_qa_pairs_livedoor.csv | livedoor | a10_hybrid | qa |
| raw_cc_news | OUTPUT/cc_news.txt | cc_news | raw_text | raw |
| raw_livedoor | OUTPUT/livedoor.txt | livedoor | raw_text | raw |

### 3.2 ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š

```python
DEFAULTS = {
    "rag": {
        "include_answer_in_embedding": False,
    },
    "embeddings": {
        "primary": {
            "provider": "openai",
            "model": "text-embedding-3-small",
            "dims": 1536
        },
    },
    "qdrant": {"url": "http://localhost:6333"},
}
```

---

## 4. ãƒ‡ãƒ¼ã‚¿å‡¦ç†æ©Ÿèƒ½

### 4.1 CSVãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ (load_csv: 299-317)

```python
def load_csv(path: str, required=("question", "answer"), limit: int = 0) -> pd.DataFrame:
    """Q&A CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿

    ã‚«ãƒ©ãƒ åãƒãƒƒãƒ”ãƒ³ã‚°:
    - 'Question' â†’ 'question'
    - 'Response'/'Answer'/'correct_answer' â†’ 'answer'
    """
```

### 4.2 è¨€èªè‡ªå‹•åˆ¤å®š (detect_language: 320-340)

```python
def detect_language(text: str) -> str:
    """ãƒ†ã‚­ã‚¹ãƒˆã®è¨€èªã‚’åˆ¤å®šï¼ˆæ—¥æœ¬èª or è‹±èªï¼‰

    åˆ¤å®šåŸºæº–:
    - ã²ã‚‰ãŒãªï¼ˆU+3040-U+309Fï¼‰
    - ã‚«ã‚¿ã‚«ãƒŠï¼ˆU+30A0-U+30FFï¼‰
    - æ¼¢å­—ï¼ˆU+4E00-U+9FFFï¼‰
    - æ—¥æœ¬èªæ–‡å­—ãŒ30%ä»¥ä¸Šãªã‚‰"ja"ã€ãã‚Œä»¥å¤–ã¯"en"
    """
```

### 4.3 æ—¥æœ¬èªãƒãƒ£ãƒ³ã‚¯åˆ†å‰² (chunk_japanese_text: 342-438)

```python
def chunk_japanese_text(text: str, max_tokens: int = 500) -> List[str]:
    """æ—¥æœ¬èªãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ã«ãƒãƒ£ãƒ³ã‚¯åˆ†å‰²

    å‡¦ç†ãƒ•ãƒ­ãƒ¼:
    1. æ®µè½ã§åˆ†å‰²ï¼ˆç©ºè¡ŒåŒºåˆ‡ã‚Šï¼‰
    2. æ®µè½ãŒmax_tokensã‚’è¶…ãˆã‚‹å ´åˆã¯æ–‡å˜ä½ã§åˆ†å‰²
    3. å˜ä¸€æ–‡ãŒå¤§ãã™ãã‚‹å ´åˆã¯å¼·åˆ¶çš„ã«å›ºå®šé•·åˆ†å‰²
    """
```

### 4.4 è‹±èªãƒãƒ£ãƒ³ã‚¯åˆ†å‰² (chunk_english_text: 440-534)

```python
def chunk_english_text(text: str, max_tokens: int = 500) -> List[str]:
    """è‹±èªãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ã«ãƒãƒ£ãƒ³ã‚¯åˆ†å‰²

    å‡¦ç†ãƒ•ãƒ­ãƒ¼:
    1. æ®µè½ã§åˆ†å‰²ï¼ˆç©ºè¡ŒåŒºåˆ‡ã‚Šï¼‰
    2. æ®µè½ãŒmax_tokensã‚’è¶…ãˆã‚‹å ´åˆã¯æ–‡å˜ä½ã§åˆ†å‰²
       - ãƒ”ãƒªã‚ªãƒ‰+ã‚¹ãƒšãƒ¼ã‚¹+å¤§æ–‡å­—ã§åˆ†å‰²ï¼ˆç•¥èªã‚’è€ƒæ…®ï¼‰
    3. å˜ä¸€æ–‡ãŒå¤§ãã™ãã‚‹å ´åˆã¯å¼·åˆ¶çš„ã«å›ºå®šé•·åˆ†å‰²
    """
```

### 4.5 TXTãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ (load_txt: 536-573)

```python
def load_txt(path: str, limit: int = 0, chunk_size: int = 500) -> pd.DataFrame:
    """ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã€ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒ£ãƒ³ã‚¯ã«åˆ†å‰²

    å‡¦ç†:
    1. è¨€èªè‡ªå‹•åˆ¤å®šï¼ˆå…ˆé ­1000æ–‡å­—ï¼‰
    2. è¨€èªã«å¿œã˜ãŸãƒãƒ£ãƒ³ã‚¯åˆ†å‰²
    3. DataFrameã«å¤‰æ›ï¼ˆtextã‚«ãƒ©ãƒ ã®ã¿ï¼‰
    """
```

---

## 5. åŸ‹ã‚è¾¼ã¿ç”Ÿæˆ

### 5.1 embed_texts (211-290)

```python
def embed_texts(texts: List[str], model: str, batch_size: int = 128) -> List[List[float]]:
    """ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒãƒƒãƒå‡¦ç†ã§Embeddingã«å¤‰æ›

    ç‰¹å¾´:
    - OpenAIã®8192ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™ã‚’è€ƒæ…®ã—ã¦å‹•çš„ã«ãƒãƒƒãƒã‚µã‚¤ã‚ºã‚’èª¿æ•´
    - ç©ºæ–‡å­—åˆ—ãƒ»ç©ºç™½ã®ã¿ã®æ–‡å­—åˆ—ã¯ã‚¼ãƒ­ãƒ™ã‚¯ãƒˆãƒ«ã§è£œå®Œ
    - é€²æ—è¡¨ç¤ºï¼ˆãƒãƒƒãƒæ•°ã€ä»¶æ•°ã€ãƒˆãƒ¼ã‚¯ãƒ³æ•°ï¼‰
    """
```

**ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™å‡¦ç†**:
```python
MAX_TOKENS_PER_REQUEST = 8000  # 8192ã‹ã‚‰ä½™è£•ã‚’æŒãŸã›ã¦8000

# è¿½åŠ å‰ã«ãƒã‚§ãƒƒã‚¯ï¼šåˆ¶é™ã‚’è¶…ãˆã‚‹å ´åˆã¯å…ˆã«ãƒãƒƒãƒã‚’é€ä¿¡
if current_tokens + text_tokens > MAX_TOKENS_PER_REQUEST:
    # ç¾åœ¨ã®ãƒãƒƒãƒã‚’é€ä¿¡
    valid_vecs.extend(embed_texts_openai(current_batch, model=model, client=client))
    current_batch = []
    current_tokens = 0
```

---

## 6. ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³

### 6.1 å…¨ã‚ªãƒ—ã‚·ãƒ§ãƒ³ä¸€è¦§

| ã‚ªãƒ—ã‚·ãƒ§ãƒ³ | å‹ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|-----------|---|----------|------|
| `--recreate` | flag | False | ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã—ã¦æ–°è¦ä½œæˆ |
| `--collection` | str | ãªã— | ç‰¹å®šã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ã¿å‡¦ç† |
| `--input-file` | str | ãªã— | ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç™»éŒ²ï¼ˆCSV/TXT/JSON/JSONLï¼‰ |
| `--qdrant-url` | str | http://localhost:6333 | Qdrantã‚µãƒ¼ãƒãƒ¼ã®URL |
| `--batch-size` | int | 32 | Embeddings/Upsertãƒãƒƒãƒã‚µã‚¤ã‚º |
| `--limit` | int | 0 | ãƒ‡ãƒ¼ã‚¿ä»¶æ•°ä¸Šé™ï¼ˆ0=ç„¡åˆ¶é™ï¼‰ |
| `--include-answer` | flag | False | åŸ‹ã‚è¾¼ã¿ã«answerã‚‚å«ã‚ã‚‹ |
| `--search` | str | ãªã— | æ¤œç´¢ãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ |
| `--topk` | int | 5 | æ¤œç´¢çµæœã®ä¸Šä½ä»¶æ•° |

### 6.2 --input-file ã§ã®ãƒ‰ãƒ¡ã‚¤ãƒ³è‡ªå‹•æ¨å®š

ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰è‡ªå‹•çš„ã«ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’æ¨å®š:
- `cc_news`ã‚’å«ã‚€ â†’ domain: `cc_news`
- `livedoor`ã‚’å«ã‚€ â†’ domain: `livedoor`
- `upload`ã‚’å«ã‚€ â†’ domain: `custom_upload`
- ãã®ä»– â†’ domain: `custom`

---

## 7. ä½¿ç”¨æ–¹æ³•

### 7.1 å‰ææ¡ä»¶

```bash
# 1. OpenAI APIã‚­ãƒ¼ã®è¨­å®š
export OPENAI_API_KEY="sk-..."

# 2. Qdrantã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•
docker run -p 6333:6333 -p 6334:6334 qdrant/qdrant

# ã¾ãŸã¯ docker-compose
cd docker-compose
docker-compose up -d qdrant
```

### 7.2 å…¨ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¸ã®ç™»éŒ²ï¼ˆæ¨å¥¨ï¼‰

```bash
python a42_qdrant_registration.py --recreate --include-answer
```

### 7.3 ç‰¹å®šã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ã¿ã®ç™»éŒ²

```bash
# CC News LLMç”Ÿæˆæ–¹å¼
python a42_qdrant_registration.py --collection qa_cc_news_a02_llm --recreate --include-answer

# Livedoor ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ–¹å¼
python a42_qdrant_registration.py --collection qa_livedoor_a10_hybrid --recreate --include-answer

# ç”Ÿãƒ†ã‚­ã‚¹ãƒˆï¼ˆCC Newsï¼‰
python a42_qdrant_registration.py --collection raw_cc_news --recreate
```

### 7.4 ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ç™»éŒ²

```bash
# CSVãƒ•ã‚¡ã‚¤ãƒ«
python a42_qdrant_registration.py \
    --input-file qa_output/qa_pairs_upload_20251122_182355.csv \
    --recreate \
    --include-answer

# TXTãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆç”Ÿãƒ†ã‚­ã‚¹ãƒˆã€è‡ªå‹•ãƒãƒ£ãƒ³ã‚¯åˆ†å‰²ï¼‰
python a42_qdrant_registration.py \
    --input-file data/my_documents.txt \
    --recreate

# ä»¶æ•°åˆ¶é™ä»˜ã
python a42_qdrant_registration.py \
    --input-file data/large_dataset.csv \
    --limit 100 \
    --include-answer
```

### 7.5 å®Ÿè¡Œä¾‹

```
[INFO] å‡¦ç†å¯¾è±¡: 8 ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
================================================================================

ğŸ“¦ ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³: qa_cc_news_a02_llm
   èª¬æ˜: LLMç”Ÿæˆæ–¹å¼ï¼ˆa02_make_qa_para.pyï¼‰
   ã‚½ãƒ¼ã‚¹: qa_output/a02_qa_pairs_cc_news.csv
--------------------------------------------------------------------------------
   ãƒ‡ãƒ¼ã‚¿ä»¶æ•°: 5,042ä»¶
   åŸ‹ã‚è¾¼ã¿ç”Ÿæˆä¸­: primary (model=text-embedding-3-small)...
   åŸ‹ã‚è¾¼ã¿ç”Ÿæˆä¸­: ãƒãƒƒãƒ1 (100ä»¶, 7500ãƒˆãƒ¼ã‚¯ãƒ³)...
   ã‚¢ãƒƒãƒ—ã‚µãƒ¼ãƒˆä¸­... âœ“ 5,042ä»¶

ğŸ“¦ ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³: raw_cc_news
   èª¬æ˜: ç”Ÿãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ï¼ˆcc_newsï¼‰
   ã‚½ãƒ¼ã‚¹: OUTPUT/cc_news.txt
--------------------------------------------------------------------------------
   è¨€èªåˆ¤å®š: è‹±èª
   ãƒãƒ£ãƒ³ã‚¯æ•°: 3,256ä»¶ï¼ˆæœ€å¤§500ãƒˆãƒ¼ã‚¯ãƒ³/ãƒãƒ£ãƒ³ã‚¯ï¼‰
   åŸ‹ã‚è¾¼ã¿ç”Ÿæˆä¸­: primary (model=text-embedding-3-small)... âœ“
   ã‚¢ãƒƒãƒ—ã‚µãƒ¼ãƒˆä¸­... âœ“ 3,256ä»¶

================================================================================
âœ… å®Œäº†: ç·ç™»éŒ²ä»¶æ•° 15,234ä»¶

[INFO] ç™»éŒ²ã•ã‚ŒãŸã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ä¸€è¦§:
--------------------------------------------------------------------------------
  â€¢ qa_cc_news_a02_llm
  â€¢ qa_cc_news_a03_rule
  â€¢ qa_cc_news_a10_hybrid
  â€¢ qa_livedoor_a02_20_llm
  â€¢ qa_livedoor_a03_rule
  â€¢ qa_livedoor_a10_hybrid
  â€¢ raw_cc_news
  â€¢ raw_livedoor
--------------------------------------------------------------------------------
```

---

## 8. æ¤œç´¢æ©Ÿèƒ½

### 8.1 æ¤œç´¢ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ

```bash
# Q&Aã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§æ¤œç´¢
python a42_qdrant_registration.py --search "æ°—å€™å¤‰å‹•" --collection qa_cc_news_a02_llm

# ç”Ÿãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§æ¤œç´¢
python a42_qdrant_registration.py --search "ç’°å¢ƒå•é¡Œ" --collection raw_cc_news --topk 10
```

### 8.2 æ¤œç´¢çµæœã®ä¾‹

```
[Search] collection=qa_cc_news_a02_llm query='æ°—å€™å¤‰å‹•'
score=0.8234  method=a02_make_qa  Q: æ°—å€™å¤‰å‹•ãŒã‚‚ãŸã‚‰ã™å½±éŸ¿ã¯ï¼Ÿ  A: æµ·é¢ä¸Šæ˜‡ã€ç•°å¸¸æ°—è±¡ã®å¢—åŠ ...
score=0.7956  method=a02_make_qa  Q: ãƒ‘ãƒªå”å®šã®ç›®æ¨™ã¯ï¼Ÿ  A: ä¸–ç•Œã®å¹³å‡æ°—æ¸©ä¸Šæ˜‡ã‚’ç”£æ¥­é©å‘½å‰æ¯”ã§...
```

### 8.3 ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰æ§‹é€ 

**Q&Aãƒšã‚¢ç”¨**:
```json
{
  "domain": "cc_news",
  "generation_method": "a02_make_qa",
  "question": "è³ªå•æ–‡",
  "answer": "å›ç­”æ–‡",
  "source": "a02_qa_pairs_cc_news.csv",
  "created_at": "2025-11-01T12:00:00Z",
  "schema": "qa:v1"
}
```

**ç”Ÿãƒ†ã‚­ã‚¹ãƒˆç”¨**:
```json
{
  "domain": "cc_news",
  "generation_method": "raw_text",
  "text": "ãƒãƒ£ãƒ³ã‚¯ãƒ†ã‚­ã‚¹ãƒˆ...",
  "source": "cc_news.txt",
  "created_at": "2025-11-01T12:00:00Z",
  "schema": "raw:v1"
}
```

---

## 9. ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### 9.1 CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„

**ç—‡çŠ¶**:
```
[WARN] ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: qa_output/a02_qa_pairs_cc_news.csv (ã‚¹ã‚­ãƒƒãƒ—)
```

**è§£æ±ºæ–¹æ³•**:
```bash
# Q&Aç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
python a02_make_qa_para.py --dataset cc_news
```

### 9.2 Qdrantã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ããªã„

**ç—‡çŠ¶**:
```
qdrant_client.http.exceptions.ResponseHandlingException: Connection refused
```

**è§£æ±ºæ–¹æ³•**:
```bash
# Qdrantã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
docker run -p 6333:6333 -p 6334:6334 qdrant/qdrant

# ã¾ãŸã¯ docker-compose
cd docker-compose
docker-compose up -d qdrant
```

### 9.3 OpenAI APIã‚­ãƒ¼ã‚¨ãƒ©ãƒ¼

**ç—‡çŠ¶**:
```
openai.AuthenticationError: No API key provided
```

**è§£æ±ºæ–¹æ³•**:
```bash
export OPENAI_API_KEY="sk-..."
```

### 9.4 ãƒˆãƒ¼ã‚¯ãƒ³æ•°è¶…éã‚¨ãƒ©ãƒ¼

**ç—‡çŠ¶**:
```
ValueError: Single text at index X has Y tokens, which exceeds MAX_TOKENS_PER_REQUEST (8000)
```

**è§£æ±ºæ–¹æ³•**:
- ãƒãƒ£ãƒ³ã‚¯åˆ†å‰²æ™‚ã®`max_tokens`ã‚’å°ã•ãã™ã‚‹
- ã¾ãŸã¯ã€é•·ã™ãã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚’äº‹å‰ã«åˆ†å‰²

### 9.5 æ¤œç´¢ã§ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³æœªæŒ‡å®š

**ç—‡çŠ¶**:
```
[ERROR] æ¤œç´¢ã«ã¯ --collection ã®æŒ‡å®šãŒå¿…è¦ã§ã™
```

**è§£æ±ºæ–¹æ³•**:
```bash
python a42_qdrant_registration.py --search "ã‚¯ã‚¨ãƒª" --collection qa_cc_news_a02_llm
```

---

## ä»˜éŒ²: ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿

| é …ç›® | å€¤ |
|------|-----|
| ãƒ•ã‚¡ã‚¤ãƒ«è¡Œæ•° | 901è¡Œ |
| ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆQdrant URL | http://localhost:6333 |
| ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒƒãƒã‚µã‚¤ã‚º | 32 |
| åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ‡ãƒ« | text-embedding-3-small |
| åŸ‹ã‚è¾¼ã¿æ¬¡å…ƒæ•° | 1536 |
| æœ€å¤§ãƒˆãƒ¼ã‚¯ãƒ³/ãƒªã‚¯ã‚¨ã‚¹ãƒˆ | 8000 |
| ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºï¼ˆTXTï¼‰ | 500ãƒˆãƒ¼ã‚¯ãƒ³ |
| ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³æ•° | 8ï¼ˆQ&A 6 + raw 2ï¼‰ |

## é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

| ãƒ•ã‚¡ã‚¤ãƒ« | å½¹å‰² |
|---------|------|
| a02_make_qa_para.py | LLMã«ã‚ˆã‚‹Q&Aç”Ÿæˆ |
| a03_rag_qa_coverage_improved.py | ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹Q&Aç”Ÿæˆ |
| a10_qa_optimized_hybrid_batch.py | ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰Q&Aç”Ÿæˆ |
| a40_show_qdrant_data.py | Qdrantãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºUI |
| a41_qdrant_truncate.py | ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å‰Šé™¤ãƒ„ãƒ¼ãƒ« |
| a50_rag_search_local_qdrant.py | Qdrantæ¤œç´¢UI |