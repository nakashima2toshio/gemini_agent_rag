# Gemini Hybrid RAG Agent - ç†è«–ã¨å®Ÿè£…ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹

æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€ReAct + Reflection ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ç†è«–çš„èƒŒæ™¯ï¼ˆæ¦‚å¿µå›³ï¼‰ã¨ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠå¯èƒ½ãªGeminiãƒ¢ãƒ‡ãƒ«ã‚’æ´»ç”¨ã—ãŸ`agent_rag.py` ãŠã‚ˆã³é–¢é€£ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å®Ÿè£…è©³ç´°ã‚’ä½“ç³»çš„ã«ã¾ã¨ã‚ãŸãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã§ã™ã€‚

---

# ç¬¬1éƒ¨: ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚å¿µ (Theoretical Architecture)

Gemini ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ã¯ã€å¤§ãã2ã¤ã®ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆè§£æ±ºã¨æ¨æ•²ï¼‰ã§æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ã€‚

## 1.1 Phase 1: ReAct (è©¦è¡ŒéŒ¯èª¤ã«ã‚ˆã‚‹è§£æ±º)
ReActã¯ã€**ã€Œè€ƒãˆï¼ˆReasoningï¼‰ã€ãªãŒã‚‰ã€Œè¡Œå‹•ï¼ˆActingï¼‰ã€ã—ã€ãã®çµæœã‚’è¦‹ã¦ã¾ãŸã€Œè€ƒãˆã‚‹ã€**ã¨ã„ã†ãƒ—ãƒ­ã‚»ã‚¹ã§ã™ã€‚
AIã¯å˜ã«å›ç­”ã‚’å‡ºåŠ›ã™ã‚‹ã®ã§ã¯ãªãã€å¤–éƒ¨ãƒ„ãƒ¼ãƒ«ï¼ˆæ¤œç´¢ãªã©ï¼‰ã‚’ä½¿ã„ãªãŒã‚‰ã€æƒ…å ±ãŒæƒã†ã¾ã§è¡Œå‹•ã‚’ç¹°ã‚Šè¿”ã—ã¾ã™ã€‚

```mermaid
flowchart LR
    Start([ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¾é ¼]) --> Thought1
    subgraph ReAct_Loop [ReActãƒ«ãƒ¼ãƒ—: è§£æ±ºãƒ‘ãƒ¼ãƒˆ]
        Thought1[Thought: ä½•ãŒå¿…è¦ã‹è€ƒãˆã‚‹] --> Action[Action: ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œ/æ¤œç´¢]
        Action --> Observation[Observation: çµæœã‚’è¦³å¯Ÿ]
        Observation --> Decision{æƒ…å ±ååˆ†?}
        Decision -- No --> Thought1
    end
    Decision -- Yes --> FinalAns[Draft Answer: å›ç­”æ¡ˆã®ç”Ÿæˆ]
```

*   **Thought**: ç¾åœ¨ã®çŠ¶æ…‹ã‚’åˆ†æã—ã€æ¬¡ã«ä½•ã‚’ã™ã¹ãã‹è¨ˆç”»ã—ã¾ã™ã€‚
*   **Action**: ãƒ„ãƒ¼ãƒ«ï¼ˆæ¤œç´¢ï¼‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
*   **Observation**: ãƒ„ãƒ¼ãƒ«ã®å®Ÿè¡Œçµæœï¼ˆæ¤œç´¢çµæœï¼‰ã‚’å—ã‘å–ã‚Šã¾ã™ã€‚

### å…¥åŠ›æ–‡å­—åˆ—ã‹ã‚‰æ¤œç´¢ã‚¯ã‚¨ãƒªç”Ÿæˆã¾ã§ã®å‡¦ç†æ§‹é€ 

Pythonã‚³ãƒ¼ãƒ‰å´ã§ã€Œã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡ºã€ã‚„ã€Œã‚¯ã‚¨ãƒªæ•´å½¢ã€ã‚’è¡Œã†å°‚ç”¨ã®é–¢æ•°ã¯å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
Geminiãƒ¢ãƒ‡ãƒ«è‡ªä½“ãŒã€ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æŒ‡ç¤ºã«åŸºã¥ãã€ã€Œå…¥åŠ›æ–‡ã€ã‚’è§£é‡ˆã—ã€ã€Œæœ€é©ãªæ¤œç´¢ã‚¯ã‚¨ãƒªã€ã¸ã¨å¤‰æ›ï¼ˆæ¨è«–ï¼‰ ã—ã¦ã„ã¾ã™ã€‚

1. å…¥åŠ›ãƒ•ã‚§ãƒ¼ã‚º (Pythonã‚³ãƒ¼ãƒ‰: `ui/pages/agent_chat_page.py`)

* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¡Œå‹•:
  ãƒãƒ£ãƒƒãƒˆç”»é¢ã«è‡ªç„¶æ–‡ã§è³ªå•ã‚’å…¥åŠ›ã—ã¾ã™ã€‚
  > å…·ä½“ä¾‹: ã€Œå®Ÿé¨“ç”Ÿç‰©å­¦ã§ã¯ã€ç”Ÿç‰©ã®æ©Ÿæ§‹ã‚’è§£æ˜ã™ã‚‹ãŸã‚ã«ã©ã®ã‚ˆã†ãªæ“ä½œã‚’åŠ ãˆã¾ã™ã‹ï¼Ÿã€

* ã‚³ãƒ¼ãƒ‰å‡¦ç† (`run_agent_turn` é–¢æ•°):
  ã“ã®æ–‡å­—åˆ—ã¯ãã®ã¾ã¾ Gemini API (chat_session.send_message) ã«æ¸¡ã•ã‚Œã¾ã™ã€‚
  åŒæ™‚ã«ã€ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ (SYSTEM_INSTRUCTION_TEMPLATE) ã«ã‚ˆã£ã¦ã€ãƒ¢ãƒ‡ãƒ«ã«ã¯ä»¥ä¸‹ã®ã€Œæ€è€ƒã®ãƒ«ãƒ¼ãƒ«ã€ãŒä¸ãˆã‚‰ã‚Œã¦ã„ã¾ã™ã€‚
  > æŒ‡ç¤º: ã€ŒThought: [ãªãœæ¤œç´¢ãŒå¿…è¦ã‹ã€ã©ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã€ã©ã‚“ãªã‚¯ã‚¨ãƒªã§æ¤œç´¢ã™ã‚‹ã‹]ã€

2. ç”Ÿæˆãƒ»æ¨è«–ãƒ•ã‚§ãƒ¼ã‚º (Gemini API å†…éƒ¨)

* ãƒ¢ãƒ‡ãƒ«ã®æ€è€ƒ (Reasoning):
  ãƒ¢ãƒ‡ãƒ«ã¯ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æŒ‡ç¤ºã«å¾“ã„ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ„å›³ã‚’æ±²ã¿å–ã‚Šã¤ã¤ã€æ¤œç´¢ãƒ„ãƒ¼ãƒ« (search_rag_knowledge_base)
  ã«æ¸¡ã™ã¹ãæœ€é©ãªå¼•æ•°ã‚’è€ƒãˆã¾ã™ã€‚
  > æ€è€ƒä¾‹: ã€Œã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã¯é•·ã„ã€‚Qdrantã§æ­£ç¢ºã«æ¤œç´¢ã™ã‚‹ã«ã¯ã€åŠ©è©ã‚’çœã„ã¦é‡è¦ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«çµã£ãŸã»ã†ãŒè‰¯ã„ã ã‚ã†ã€‚ã€

* ã‚¯ã‚¨ãƒªã®æ±ºå®š (Function Call ç”Ÿæˆ):
  ãƒ¢ãƒ‡ãƒ«ã¯æ€è€ƒã®çµæœã«åŸºã¥ãã€ãƒ„ãƒ¼ãƒ«ã®å¼•æ•° query ã‚’ç”Ÿæˆã—ã¾ã™ã€‚ã“ã“ã§ã®å‡ºåŠ›ãŒã€å®Ÿéš›ã®æ¤œç´¢ã‚¯ã‚¨ãƒªã¨ãªã‚Šã¾ã™ã€‚

  > ç”Ÿæˆãƒ‘ã‚¿ãƒ¼ãƒ³ä¾‹:
  >    ã‚±ãƒ¼ã‚¹A (é‡è¦èªæŠ½å‡º)*: "å®Ÿé¨“ç”Ÿç‰©å­¦ ç”Ÿç‰©ã®æ©Ÿæ§‹ æ“ä½œ"
  >    ã‚±ãƒ¼ã‚¹B (ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åŒ–)*: "å®Ÿé¨“ç”Ÿç‰©å­¦ å®Ÿé¨“æ“ä½œ"
  >    ã‚±ãƒ¼ã‚¹C (ãã®ã¾ã¾)*: "å®Ÿé¨“ç”Ÿç‰©å­¦ã§ã¯ã€ç”Ÿç‰©ã®æ©Ÿæ§‹ã‚’è§£æ˜ã™ã‚‹ãŸã‚ã«ã©ã®ã‚ˆã†ãªæ“ä½œã‚’åŠ ãˆã¾ã™ã‹ï¼Ÿ"


â€»ç¾çŠ¶ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ã¯ã€Œã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ã¿ã«ã›ã‚ˆã€ã¨ã„ã†å¼·åˆ¶ã¯ãªã„ãŸã‚ã€ãƒ¢ãƒ‡ãƒ«ã®æ–‡è„ˆåˆ¤æ–­ã«ã‚ˆã‚Šã‚±ãƒ¼ã‚¹Aï½Cã®ã‚ˆã†ã«å¤‰å‹•ã—ã¾ã™ã€‚ã—ã‹ã—ã€Gemini
2.0 Flashã¯ä¸€èˆ¬çš„ã«ã€æ¤œç´¢ã«é©ã—ãŸå½¢ï¼ˆã‚±ãƒ¼ã‚¹Aã‚„Bï¼‰ã¸è‡ªç™ºçš„ã«å¤‰æ›ã™ã‚‹å‚¾å‘ãŒã‚ã‚Šã¾ã™ã€‚

3. ä¼é”ãƒ»å®Ÿè¡Œãƒ•ã‚§ãƒ¼ã‚º (Pythonã‚³ãƒ¼ãƒ‰: `agent_tools.py`)

* ã‚³ãƒ¼ãƒ‰å‡¦ç† (`run_agent_turn` -> `search_rag_knowledge_base`):
  Gemini API ã‹ã‚‰è¿”ã£ã¦ããŸ function_call æƒ…å ±ï¼ˆãƒ¢ãƒ‡ãƒ«ãŒæ±ºã‚ãŸã‚¯ã‚¨ãƒªï¼‰ã‚’ Python å´ã§å—ã‘å–ã‚Šã€ãã®ã¾ã¾æ¤œç´¢é–¢æ•°ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```python
# agent_tools.py
def search_rag_knowledge_base(query: str, ...):
    # ã“ã“ã«æ¥ã‚‹æ™‚ç‚¹ã§ã€query ã¯æ—¢ã«ãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã£ã¦
    # "å®Ÿé¨“ç”Ÿç‰©å­¦ å®Ÿé¨“æ“ä½œ" ãªã©ã«å¤‰æ›ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
    return qdrant_service.search_collection_rag(query, ...)
```

ã¾ã¨ã‚

| ãƒ•ã‚§ãƒ¼ã‚º | æ‹…å½“             | å‡¦ç†å†…å®¹                                 | å…·ä½“ä¾‹                                  |
| :------- | :--------------- | :--------------------------------------- | :------------------------------------------ |
| 1. å…¥åŠ›  | agent_chat_page.py | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è‡ªç„¶æ–‡ã‚’å—ã‘å–ã‚‹               | ã€Œå®Ÿé¨“ç”Ÿç‰©å­¦ã§ã¯...æ“ä½œã‚’åŠ ãˆã¾ã™ã‹ï¼Ÿã€ |
| 2. å¤‰æ›  | Gemini (LLM)     | æ–‡è„ˆã‹ã‚‰ã€Œæ¤œç´¢ç”¨ã‚¯ã‚¨ãƒªã€ã‚’æ¨è«–ãƒ»ç”Ÿæˆã™ã‚‹ | ã€Œå®Ÿé¨“ç”Ÿç‰©å­¦ å®Ÿé¨“æ“ä½œã€ (ã‚±ãƒ¼ã‚¹B)       |
| 3. å®Ÿè¡Œ  | agent_tools.py   | ç”Ÿæˆã•ã‚ŒãŸã‚¯ã‚¨ãƒªã§æ¤œç´¢ã‚’å®Ÿè¡Œã™ã‚‹         | query="å®Ÿé¨“ç”Ÿç‰©å­¦ å®Ÿé¨“æ“ä½œ" ã§æ¤œç´¢      |


ã¤ã¾ã‚Šã€ã€Œã‚¯ã‚¨ãƒªç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã€ã®å®Ÿä½“ã¯ Python ã‚³ãƒ¼ãƒ‰ã§ã¯ãªãã€LLM ã®é ­è„³ï¼ˆæ¨è«–ãƒ—ãƒ­ã‚»ã‚¹ï¼‰ã®ä¸­ ã«ã‚ã‚Šã¾ã™ã€‚


## 1.2 Phase 2: Reflection (è‡ªå·±çœå¯Ÿã¨æ¨æ•²)
Reflectionã¯ã€ç”Ÿæˆã•ã‚ŒãŸå›ç­”ï¼ˆãƒ‰ãƒ©ãƒ•ãƒˆï¼‰ã«å¯¾ã—ã¦å®¢è¦³çš„ãªæ‰¹è©•ã‚’è¡Œã„ã€å“è³ªã‚’é«˜ã‚ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã§ã™ã€‚

```mermaid
flowchart LR
    Input([Draft Answer]) --> Reflect
    subgraph Reflection_Loop [Reflectionãƒ«ãƒ¼ãƒ—: æ¨æ•²ãƒ‘ãƒ¼ãƒˆ]
        Reflect[Reflect: æ‰¹è©•ãƒ»ãƒã‚§ãƒƒã‚¯] --> Check{å•é¡Œãªã—?}
        Check -- No --> Revise[Revise: ä¿®æ­£ç‰ˆä½œæˆ]
        Revise --> Reflect
    end
    Check -- Yes --> Output([Final Answer])
```

*   **Reflect**: æ­£ç¢ºæ€§ã€é©åˆ‡æ€§ã€ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚
*   **Revise**: å•é¡ŒãŒã‚ã‚Œã°ä¿®æ­£ã—ã€æœ€çµ‚å›ç­”ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

## 1.3 çµ±åˆãƒ¢ãƒ‡ãƒ« (ReAct + Reflection)
ã€Œå‹•ãï¼ˆActionï¼‰ã€ãƒ•ã‚§ãƒ¼ã‚ºã¨ã€Œè€ƒãˆã‚‹ï¼ˆReflectionï¼‰ã€ãƒ•ã‚§ãƒ¼ã‚ºã‚’é€£æºã•ã›ã‚‹ã“ã¨ã§ã€ã‚ˆã‚Šé«˜åº¦ãªæˆæœç‰©ã‚’ç”Ÿã¿å‡ºã—ã¾ã™ã€‚

```mermaid
flowchart TD
    User([ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¾é ¼]) --> P1
    subgraph Phase1 [Phase 1: ReAct Loop]
        direction TB
        Reasoning[æ€è€ƒã¨è¡Œå‹•ã®ç¹°ã‚Šè¿”ã—] --> Draft[ãƒ‰ãƒ©ãƒ•ãƒˆå›ç­”ã®ä½œæˆ]
    end

    P1 --> P2

    subgraph Phase2 [Phase 2: Reflection Loop]
        direction TB
        Draft --> Critique[ãƒ‰ãƒ©ãƒ•ãƒˆã¨ä¾é ¼ã‚’æ¯”è¼ƒãƒ»æ‰¹è©•]
        Critique --> Revise[ä¿®æ­£ã¨æ´—ç·´]
    end

    Revise --> Final([Final Answer: æœ€çµ‚å›ç­”])
```

---

# ç¬¬2éƒ¨: å®Ÿè£…è©³ç´° (Implementation Details)

ä¸Šè¨˜ã®ç†è«–ãŒã€å®Ÿéš›ã®Pythonã‚³ãƒ¼ãƒ‰ã§ã©ã®ã‚ˆã†ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹è§£èª¬ã—ã¾ã™ã€‚

## 2.1 ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåˆ¶å¾¡: `ui/pages/agent_chat_page.py`

ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†ã‚’è¡Œã†ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã§ã™ã€‚

*   **`setup_agent(selected_collections, model_name)` é–¢æ•°**:
    *   **å½¹å‰²**: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’åˆæœŸåŒ–ã—ã€`google.generativeai.GenerativeModel` ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
    *   **è©³ç´°**: UIã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠã—ãŸ `model_name` ã‚’å¼•æ•°ã¨ã—ã¦å—ã‘å–ã‚Šã€ãã®ãƒ¢ãƒ‡ãƒ«åã‚’ä½¿ç”¨ã—ã¦LLMã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€åˆ©ç”¨ã™ã‚‹Geminiãƒ¢ãƒ‡ãƒ«ã‚’å‹•çš„ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

### ReActãƒ«ãƒ¼ãƒ—ã®å®Ÿè£… (`run_agent_turn`)
Gemini API ã® `function_call` æ©Ÿèƒ½ã¨ Python ã® `while` ãƒ«ãƒ¼ãƒ—ã‚’çµ„ã¿åˆã‚ã›ã¦ ReAct ã‚’å®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚

```mermaid
flowchart TD
    User([ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›]) --> Start
    subgraph Agent_Process [run_agent_turn é–¢æ•°]
        direction TB
        Start[é–‹å§‹] --> ReAct_Phase
        
        subgraph ReAct_Phase [Phase 1: ReAct Loopã®å®Ÿè£…]
            Think[æ€è€ƒ Thought] --> Decide{ãƒ„ãƒ¼ãƒ«å¿…è¦?}
            Decide -- Yes --> Action[è¡Œå‹•: part.function_call]
            Action --> Observe[è¦³å¯Ÿ: æ¤œç´¢çµæœå–å¾—]
            Observe --> Think
            Decide -- No --> Draft[ãƒ‰ãƒ©ãƒ•ãƒˆå›ç­”ç”Ÿæˆ]
        end
        
        Draft --> Reflection_Phase
        
        subgraph Reflection_Phase [Phase 2: Reflectionã®å®Ÿè£…]
            Review[æ¨æ•²ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé€ä¿¡] --> Critique[è‡ªå·±è©•ä¾¡ & ä¿®æ­£]
            Critique --> Finalize[æœ€çµ‚å›ç­”æŠ½å‡º]
        end
    end
    Finalize --> Output([ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å›ç­”])
```

*   **ã‚³ãƒ¼ãƒ‰å¯¾å¿œ**: `run_agent_turn` é–¢æ•°å†…ã® `while turn_count < max_turns:` ãƒ«ãƒ¼ãƒ—ã€‚
*   **Thoughtã®å¯è¦–åŒ–**: ãƒ¢ãƒ‡ãƒ«ãŒå‡ºåŠ›ã™ã‚‹ `Thought:` ãƒ‘ãƒ¼ãƒˆã‚’æŠ½å‡ºã—ã€Streamlit UI (`st.expander`) ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºã—ã¾ã™ã€‚

### ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­è¨ˆ
*   **Router Guidelines (`SYSTEM_INSTRUCTION_TEMPLATE`)**:
    *   **å½¹å‰²**: ã©ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ`wikipedia_ja`, `livedoor`, `cc_news`ï¼‰ã‚’ä½¿ã†ã¹ãã‹ã®åˆ¤æ–­åŸºæº–ã‚’æä¾›ã—ã¾ã™ã€‚
    *   **å®Ÿè£…**: LLMã¯ã“ã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã«å¾“ã„ã€è‡ªå¾‹çš„ã«é©åˆ‡ãªã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¾ã™ã€‚
*   **Reflection Strategy (`REFLECTION_INSTRUCTION`)**:
    *   **å½¹å‰²**: ãƒ‰ãƒ©ãƒ•ãƒˆå›ç­”ã«å¯¾ã™ã‚‹è©•ä¾¡åŸºæº–ï¼ˆæ­£ç¢ºæ€§ãƒ»é©åˆ‡æ€§ãƒ»ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ã‚’å®šç¾©ã—ã¾ã™ã€‚

## 2.2 ãƒ„ãƒ¼ãƒ«å®šç¾©: `agent_tools.py`

LLM ãŒå‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã‚‹ã€Œæ‰‹è¶³ã€ã¨ãªã‚‹é–¢æ•°ç¾¤ã§ã™ã€‚

*   **`search_rag_knowledge_base(query, collection_name)`**:
    *   **å½¹å‰²**: æŒ‡å®šã•ã‚ŒãŸã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«å¯¾ã—ã¦æ¤œç´¢ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
    *   **è©³ç´°**: `services.qdrant_service.search_collection_rag` ã‚’ãƒ©ãƒƒãƒ—ã—ã€LLMãŒä½¿ã„ã‚„ã™ã„ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚
*   **`list_rag_collections()`**:
    *   **å½¹å‰²**: ç¾åœ¨åˆ©ç”¨å¯èƒ½ãªã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ä¸€è¦§ã‚’è¿”ã—ã¾ã™ã€‚

## 2.3 çŸ¥è­˜ãƒ™ãƒ¼ã‚¹æ¤œç´¢: `services/qdrant_service.py`

Qdrant ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã®å¯¾è©±ã€Embedding ç”Ÿæˆã€ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ã‚’æ‹…å½“ã™ã‚‹ã‚³ã‚¢ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ã™ã€‚

### Embedding (ãƒ™ã‚¯ãƒˆãƒ«åŒ–) ã®æ§‹æˆ
`helper_embedding.py` ã«é›†ç´„ã•ã‚Œã€æŠ½è±¡åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚

| é …ç›® | è©³ç´° |
| :--- | :--- |
| **æŠ½è±¡åŸºåº•ã‚¯ãƒ©ã‚¹** | `EmbeddingClient` |
| **å®Ÿè£…ã‚¯ãƒ©ã‚¹** | 1. **`GeminiEmbedding`**: Gemini API (`models.embed_content`) ã‚’ä½¿ç”¨ã€‚ç¾åœ¨ã®ä¸»åŠ›ã€‚<br>2. **`OpenAIEmbedding`**: OpenAI API ã‚’ä½¿ç”¨ã€‚ãƒ¬ã‚¬ã‚·ãƒ¼/äº’æ›ç”¨ã€‚ |
| **ãƒ•ã‚¡ã‚¯ãƒˆãƒªé–¢æ•°** | `create_embedding_client(provider="gemini", ...)` |

### æ¤œç´¢ãƒ­ã‚¸ãƒƒã‚¯ (Hybrid Search)
Qdrant ã® **Hybrid RAG (Dense + Sparse)** æ©Ÿèƒ½ã‚’æ´»ç”¨ã—ã¦ã„ã¾ã™ã€‚

| å‡¦ç†ãƒ•ã‚§ãƒ¼ã‚º | ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« / é–¢æ•° | è©³ç´° (Input / Process / Output) |
| :--- | :--- | :--- |
| **è¨­å®š (Setup)** | `qdrant_client_wrapper.py`<br>`create_or_recreate_collection` | **Input**: `client`, `name`, `vector_size`<br>**Process**: Denseãƒ™ã‚¯ãƒˆãƒ«ã¨Sparseãƒ™ã‚¯ãƒˆãƒ«ã®ä¸¡æ–¹ã®è¨­å®šã‚’è¡Œã„ã€ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã€‚<br>**Output**: ãªã— |
| **å®Ÿè¡Œ (Runtime)** | `qdrant_client_wrapper.py`<br>`search_collection` | **Input**: `client`, `collection_name`, `query_vector`<br>**Process**: Dense (æ„å‘³æ¤œç´¢) ã¨ Sparse (ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢) ã‚’çµ„ã¿åˆã‚ã›ãŸãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ã‚’å®Ÿè¡Œã€‚<br>**Output**: é«˜ç²¾åº¦ãªæ¤œç´¢çµæœãƒªã‚¹ãƒˆ |

```mermaid
graph TD
    subgraph Python App
        Query[ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›] --> |helper_embedding.py| Embed[Embeddingç”Ÿæˆ]
        Embed --> |GeminiEmbedding| API[Gemini API]
        API --> |Vector| Embed
        Embed --> |Vector| Search[search_collection]
    end

    subgraph Qdrant DB
        Search --> |Query Vector| Engine[æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³]
        Config[Hybrid Search] -.-> Engine
        Engine --> |Dense + Sparse| Score[é¡ä¼¼åº¦ã‚¹ã‚³ã‚¢ç®—å‡º]
        Score --> |Top K Results| Search
    end
```

---

# ç¬¬3éƒ¨: å‹•ä½œã‚·ãƒ¼ã‚±ãƒ³ã‚¹ (Runtime Behavior)

## 3.1 å‡¦ç†ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³
Streamlit UIã€Gemini APIã€Agent Tools é–“ã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³è©³ç´°ã§ã™ã€‚

```mermaid
sequenceDiagram
    participant UI as Agent Controller<br>(Streamlit)
    participant LLM as é¸æŠã•ã‚ŒãŸGeminiãƒ¢ãƒ‡ãƒ«
    participant Tool as Agent Tools<br>(Search/RAG)

    Note over UI, LLM: Phase 1: ReAct Loop
    UI->>LLM: send_message(ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›)
    loop è§£æ±ºã™ã‚‹ã¾ã§ç¹°ã‚Šè¿”ã—
        LLM-->>UI: å¿œç­” (Text + FunctionCall?)
        alt Function Call ã‚ã‚Š
            UI->>UI: Thoughtã‚’ãƒ­ã‚°è¡¨ç¤º
            UI->>Tool: ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œ (ä¾‹: search_rag)
            Tool-->>UI: æ¤œç´¢çµæœ (Observation)
            UI->>LLM: send_message(function_response)
        else Function Call ãªã—
            LLM-->>UI: å›ç­”æ¡ˆ (Draft Answer)
            Note over UI: ãƒ«ãƒ¼ãƒ—çµ‚äº† (break)
        end
    end
```

## 3.2 Router & Multi-turn Strategy
ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã©ã®ã‚ˆã†ã«æ¤œç´¢å¯¾è±¡ã‚’æ±ºå®šã—ã€å¤±æ•—æ™‚ã«ãƒªã‚«ãƒãƒªã™ã‚‹ã‹ã‚’ç¤ºã—ã¾ã™ã€‚

1.  **Router (ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³é¸æŠ)**:
    *   ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã®å†…å®¹ã«åŸºã¥ãã€`SYSTEM_INSTRUCTION` ã®ãƒ«ãƒ¼ãƒ«ã«å¾“ã£ã¦æœ€é©ãªã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ±ºå®šã—ã¾ã™ï¼ˆä¾‹: ä¸€èˆ¬çŸ¥è­˜ãªã‚‰ `wikipedia_ja`ï¼‰ã€‚
2.  **Multi-turn Strategy (ãƒªã‚«ãƒãƒª)**:
    *   æ¤œç´¢çµæœãŒ `[[NO_RAG_RESULT]]` ã ã£ãŸå ´åˆã€LLM ã¯å³åº§ã«è«¦ã‚ãšã€**åˆ¥ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³**ã‚’è©¦ã—ãŸã‚Šã€**ã‚¯ã‚¨ãƒªã‚’è¨€ã„æ›ãˆ**ã¦å†æ¤œç´¢ã‚’è¡Œã„ã¾ã™ã€‚

---

# ç¬¬4éƒ¨: ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹æˆå›³ (Module Dependencies)

ã‚·ã‚¹ãƒ†ãƒ ã®å…¨ä½“çš„ãªä¾å­˜é–¢ä¿‚å›³ã§ã™ã€‚

```mermaid
graph TD
    subgraph UI_Layer [UI / Controller]
        AgentPage[agent_chat_page.py<br>Main Logic]
    end

    subgraph Service_Layer [Services & Tools]
        Tools[agent_tools.py<br>Tool Definitions]
        QdrantSvc[services/qdrant_service.py<br>DB Access]
        Config[config.py]
    end

    subgraph External_API
        Gemini[google.generativeai]
        QdrantDB[(Qdrant Vector DB)]
    end

    AgentPage --> |Import/Call| Tools
    AgentPage --> |Import/Call| QdrantSvc
    AgentPage --> |Import| Config
    AgentPage --> |API Call| Gemini
    Tools --> |Search| QdrantSvc
    QdrantSvc --> |Query| QdrantDB
```

---

LLMãŒã€Œæ¤œç´¢ã«æœ€é©ã€ã¨åˆ¤æ–­ã—ãŸå½¢å¼ ã§ã‚¯ã‚¨ãƒªã‚’ç”Ÿæˆã—ã¾ã™ã€‚

ãŸã ã—ã€ä¸€èˆ¬çš„ã«RAGï¼ˆç‰¹ã«ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ï¼‰ã«ãŠã„ã¦ã¯ã€è‡ªç„¶æ–‡ã‚ˆã‚Šã‚‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å½¢å¼ã®æ–¹ãŒãƒã‚¤ã‚ºãŒæ¸›ã‚Šãƒ’ãƒƒãƒˆã—ã‚„ã™ã„å‚¾å‘ãŒã‚ã‚‹ãŸã‚ã€LLMã¯ã—ã°
ã—ã°ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡ºã®ã‚ˆã†ãªæŒ™å‹•ã‚’ã—ã¾ã™ã€‚

### å…¥åŠ›æ–‡å­—åˆ—ã‹ã‚‰æ¤œç´¢ã‚¯ã‚¨ãƒªç”Ÿæˆã¾ã§ã®å‡¦ç†æ§‹é€ 

Pythonã‚³ãƒ¼ãƒ‰å´ã§ã€Œã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡ºã€ã‚„ã€Œã‚¯ã‚¨ãƒªæ•´å½¢ã€ã‚’è¡Œã†å°‚ç”¨ã®é–¢æ•°ã¯å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
Geminiãƒ¢ãƒ‡ãƒ«è‡ªä½“ãŒã€ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æŒ‡ç¤ºã«åŸºã¥ãã€ã€Œå…¥åŠ›æ–‡ã€ã‚’è§£é‡ˆã—ã€ã€Œæœ€é©ãªæ¤œç´¢ã‚¯ã‚¨ãƒªã€ã¸ã¨å¤‰æ›ï¼ˆæ¨è«–ï¼‰ ã—ã¦ã„ã¾ã™ã€‚

1. å…¥åŠ›ãƒ•ã‚§ãƒ¼ã‚º (Pythonã‚³ãƒ¼ãƒ‰: `ui/pages/agent_chat_page.py`)

* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¡Œå‹•:
  ãƒãƒ£ãƒƒãƒˆç”»é¢ã«è‡ªç„¶æ–‡ã§è³ªå•ã‚’å…¥åŠ›ã—ã¾ã™ã€‚
  > å…·ä½“ä¾‹: ã€Œå®Ÿé¨“ç”Ÿç‰©å­¦ã§ã¯ã€ç”Ÿç‰©ã®æ©Ÿæ§‹ã‚’è§£æ˜ã™ã‚‹ãŸã‚ã«ã©ã®ã‚ˆã†ãªæ“ä½œã‚’åŠ ãˆã¾ã™ã‹ï¼Ÿã€

* ã‚³ãƒ¼ãƒ‰å‡¦ç† (`run_agent_turn` é–¢æ•°):
  ã“ã®æ–‡å­—åˆ—ã¯ãã®ã¾ã¾ Gemini API (chat_session.send_message) ã«æ¸¡ã•ã‚Œã¾ã™ã€‚
  åŒæ™‚ã«ã€ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ (SYSTEM_INSTRUCTION_TEMPLATE) ã«ã‚ˆã£ã¦ã€ãƒ¢ãƒ‡ãƒ«ã«ã¯ä»¥ä¸‹ã®ã€Œæ€è€ƒã®ãƒ«ãƒ¼ãƒ«ã€ãŒä¸ãˆã‚‰ã‚Œã¦ã„ã¾ã™ã€‚
  > æŒ‡ç¤º: ã€ŒThought: [ãªãœæ¤œç´¢ãŒå¿…è¦ã‹ã€ã©ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã€ã©ã‚“ãªã‚¯ã‚¨ãƒªã§æ¤œç´¢ã™ã‚‹ã‹]ã€

2. ç”Ÿæˆãƒ»æ¨è«–ãƒ•ã‚§ãƒ¼ã‚º (Gemini API å†…éƒ¨)

* ãƒ¢ãƒ‡ãƒ«ã®æ€è€ƒ (Reasoning):
  ãƒ¢ãƒ‡ãƒ«ã¯ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æŒ‡ç¤ºã«å¾“ã„ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ„å›³ã‚’æ±²ã¿å–ã‚Šã¤ã¤ã€æ¤œç´¢ãƒ„ãƒ¼ãƒ« (search_rag_knowledge_base)
  ã«æ¸¡ã™ã¹ãæœ€é©ãªå¼•æ•°ã‚’è€ƒãˆã¾ã™ã€‚
  > æ€è€ƒä¾‹: ã€Œã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã¯é•·ã„ã€‚Qdrantã§æ­£ç¢ºã«æ¤œç´¢ã™ã‚‹ã«ã¯ã€åŠ©è©ã‚’çœã„ã¦é‡è¦ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«çµã£ãŸã»ã†ãŒè‰¯ã„ã ã‚ã†ã€‚ã€

* ã‚¯ã‚¨ãƒªã®æ±ºå®š (Function Call ç”Ÿæˆ):
  ãƒ¢ãƒ‡ãƒ«ã¯æ€è€ƒã®çµæœã«åŸºã¥ãã€ãƒ„ãƒ¼ãƒ«ã®å¼•æ•° query ã‚’ç”Ÿæˆã—ã¾ã™ã€‚ã“ã“ã§ã®å‡ºåŠ›ãŒã€å®Ÿéš›ã®æ¤œç´¢ã‚¯ã‚¨ãƒªã¨ãªã‚Šã¾ã™ã€‚

  > ç”Ÿæˆãƒ‘ã‚¿ãƒ¼ãƒ³ä¾‹:
  >    ã‚±ãƒ¼ã‚¹A (é‡è¦èªæŠ½å‡º)*: "å®Ÿé¨“ç”Ÿç‰©å­¦ ç”Ÿç‰©ã®æ©Ÿæ§‹ æ“ä½œ"
  >    ã‚±ãƒ¼ã‚¹B (ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åŒ–)*: "å®Ÿé¨“ç”Ÿç‰©å­¦ å®Ÿé¨“æ“ä½œ"
  >    ã‚±ãƒ¼ã‚¹C (ãã®ã¾ã¾)*: "å®Ÿé¨“ç”Ÿç‰©å­¦ã§ã¯ã€ç”Ÿç‰©ã®æ©Ÿæ§‹ã‚’è§£æ˜ã™ã‚‹ãŸã‚ã«ã©ã®ã‚ˆã†ãªæ“ä½œã‚’åŠ ãˆã¾ã™ã‹ï¼Ÿ"


â€»ç¾çŠ¶ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ã¯ã€Œã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ã¿ã«ã›ã‚ˆã€ã¨ã„ã†å¼·åˆ¶ã¯ãªã„ãŸã‚ã€ãƒ¢ãƒ‡ãƒ«ã®æ–‡è„ˆåˆ¤æ–­ã«ã‚ˆã‚Šã‚±ãƒ¼ã‚¹Aï½Cã®ã‚ˆã†ã«å¤‰å‹•ã—ã¾ã™ã€‚ã—ã‹ã—ã€Gemini
2.0 Flashã¯ä¸€èˆ¬çš„ã«ã€æ¤œç´¢ã«é©ã—ãŸå½¢ï¼ˆã‚±ãƒ¼ã‚¹Aã‚„Bï¼‰ã¸è‡ªç™ºçš„ã«å¤‰æ›ã™ã‚‹å‚¾å‘ãŒã‚ã‚Šã¾ã™ã€‚

3. ä¼é”ãƒ»å®Ÿè¡Œãƒ•ã‚§ãƒ¼ã‚º (Pythonã‚³ãƒ¼ãƒ‰: `agent_tools.py`)

* ã‚³ãƒ¼ãƒ‰å‡¦ç† (`run_agent_turn` -> `search_rag_knowledge_base`):
  Gemini API ã‹ã‚‰è¿”ã£ã¦ããŸ function_call æƒ…å ±ï¼ˆãƒ¢ãƒ‡ãƒ«ãŒæ±ºã‚ãŸã‚¯ã‚¨ãƒªï¼‰ã‚’ Python å´ã§å—ã‘å–ã‚Šã€ãã®ã¾ã¾æ¤œç´¢é–¢æ•°ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

| ãƒ•ã‚§ãƒ¼ã‚º | æ‹…å½“             | å‡¦ç†å†…å®¹                                 | å…·ä½“ä¾‹                                  |
| :------- | :--------------- | :--------------------------------------- | :------------------------------------------ |
| 1. å…¥åŠ›  | agent_chat_page.py | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è‡ªç„¶æ–‡ã‚’å—ã‘å–ã‚‹               | ã€Œå®Ÿé¨“ç”Ÿç‰©å­¦ã§ã¯...æ“ä½œã‚’åŠ ãˆã¾ã™ã‹ï¼Ÿã€ |
| 2. å¤‰æ›  | Gemini (LLM)     | æ–‡è„ˆã‹ã‚‰ã€Œæ¤œç´¢ç”¨ã‚¯ã‚¨ãƒªã€ã‚’æ¨è«–ãƒ»ç”Ÿæˆã™ã‚‹ | ã€Œå®Ÿé¨“ç”Ÿç‰©å­¦ å®Ÿé¨“æ“ä½œã€ (ã‚±ãƒ¼ã‚¹B)       |
| 3. å®Ÿè¡Œ  | agent_tools.py   | ç”Ÿæˆã•ã‚ŒãŸã‚¯ã‚¨ãƒªã§æ¤œç´¢ã‚’å®Ÿè¡Œã™ã‚‹         | query="å®Ÿé¨“ç”Ÿç‰©å­¦ å®Ÿé¨“æ“ä½œ" ã§æ¤œç´¢      |


### Reflectionãƒ•ã‚§ãƒ¼ã‚º (è‡ªå·±çœå¯Ÿã¨æ¨æ•²) ã®å‡¦ç†æ§‹é€ 

æ¤œç´¢çµæœã‚’åŸºã«ä¸€åº¦å›ç­”ã‚’ä½œæˆã—ãŸå¾Œã€ã•ã‚‰ã«ã€Œæ¨æ•²ã€ã‚’è¡Œã†ãƒ—ãƒ­ã‚»ã‚¹ã§ã™ã€‚
ã“ã‚Œã«ã‚ˆã‚Šã€å›ç­”ã®æ­£ç¢ºæ€§ã‚„ã‚¹ã‚¿ã‚¤ãƒ«ãŒã€ã‚·ã‚¹ãƒ†ãƒ è¦ä»¶ï¼ˆä¸å¯§ãªæ—¥æœ¬èªãªã©ï¼‰ã«åˆè‡´ã—ã¦ã„ã‚‹ã‹è‡ªå·±è©•ä¾¡ã—ã€å¿…è¦ã«å¿œã˜ã¦ä¿®æ­£ã—ã¾ã™ã€‚

#### å…·ä½“çš„ãªæŒ™å‹•ã®ä»•çµ„ã¿

1. **ãƒ‰ãƒ©ãƒ•ãƒˆç”Ÿæˆãƒ•ã‚§ãƒ¼ã‚º** (ReActãƒ«ãƒ¼ãƒ—çµ‚äº†å¾Œ)
    *   **LLMã®æ€è€ƒ**: æ¤œç´¢çµæœï¼ˆwikipediaç­‰ï¼‰ã‹ã‚‰æƒ…å ±ã‚’å¾—ãŸã®ã§ã€å›ç­”ã‚’ä½œæˆã—ã¾ã™ã€‚
        > **æ€è€ƒä¾‹ (Thought)**: ã€Œæ¤œç´¢çµæœã‹ã‚‰ã€è³ªå•ã«å¯¾ã™ã‚‹å›ç­”ãŒå¾—ã‚‰ã‚ŒãŸã€‚ã€
    *   **å›ç­”æ¡ˆ (Draft)**:
        > ã€Œç¤¾å†…ãƒŠãƒ¬ãƒƒã‚¸ã«ã‚ˆã‚‹ã¨ã€å®Ÿé¨“ç”Ÿç‰©å­¦ã§ã¯ã€ç”Ÿç‰©ã«å‚™ã‚ã£ã¦ã„ã‚‹æ©Ÿæ§‹ã‚’è§£æ˜ã™ã‚‹ãŸã‚ã«ã€äººç‚ºçš„ã«æ“ä½œã‚’åŠ ãˆé€šå¸¸ã¨ç•°ãªã‚‹æ¡ä»¶ã‚’ä½œã‚Šå‡ºã—ã€ãã®å¾Œã®å¤‰åŒ–ã‚’è¦³å¯Ÿãƒ»è¦³æ¸¬ã—ã¾ã™ã€‚ä¾‹ãˆã°ã€çªç„¶å¤‰ç•°ã®èª˜ç™ºã‚„éºä¼å­å°å…¥ã€ç§»æ¤å®Ÿé¨“ãªã©ã‚’è¡Œã„ã¾ã™ã€‚ã€
    *   **ã‚³ãƒ¼ãƒ‰å‡¦ç† (`run_agent_turn` å¾ŒåŠ)**: ã“ã®å›ç­”æ¡ˆã‚’ä¸€æ™‚å¤‰æ•° `final_response_text` ã«ä¿æŒã—ã¾ã™ã€‚

2. **æ¨æ•²ãƒ•ã‚§ãƒ¼ã‚º** (Reflection)
    *   **ã‚³ãƒ¼ãƒ‰å‡¦ç†**: `REFLECTION_INSTRUCTION` (è©•ä¾¡ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ) ã¨ãƒ‰ãƒ©ãƒ•ãƒˆå›ç­”ã‚’çµåˆã—ã€å†åº¦ Gemini ã«é€ä¿¡ã—ã¾ã™ã€‚
        > **æŒ‡ç¤º**: ã€Œä»¥ä¸‹ã®åŸºæº–ã§å®¢è¦³çš„ã«è©•ä¾¡ã—...ä¿®æ­£ã—ã¦ãã ã•ã„...æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ã¯ Thought: ã§å§‹ã‚ã¦ãã ã•ã„ã€‚ã€

    *   **LLMã®æ€è€ƒ (Reflection Thought)**: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å¾“ã„ã€è‡ªåˆ†ã®å›ç­”ã‚’è©•ä¾¡ã—ã¾ã™ã€‚
        > **æ€è€ƒä¾‹**: ã€Œ[è‡ªå·±è©•ä¾¡: å›ç­”ã¯è³ªå•ã«ç›´æ¥çš„ã‹ã¤æ˜ç¢ºã«ç­”ãˆã¦ãŠã‚Šã€æ­£ç¢ºæ€§ã€é©åˆ‡æ€§ã€ã‚¹ã‚¿ã‚¤ãƒ«ã«ã‚‚å•é¡Œãªã„ãŸã‚ã€ä¿®æ­£ã¯ä¸è¦ã¨åˆ¤æ–­ã—ã¾ã—ãŸã€‚]ã€

    *   **æœ€çµ‚å›ç­”ã®ç”Ÿæˆ (Final Answer)**: è©•ä¾¡ã«åŸºã¥ãã€æœ€çµ‚ç‰ˆã‚’å‡ºåŠ›ã—ã¾ã™ã€‚

#### ã¾ã¨ã‚

| ãƒ•ã‚§ãƒ¼ã‚º | æ‹…å½“ | å‡¦ç†å†…å®¹ | å…·ä½“ä¾‹ |
| :------- | :--------------- | :--------------------------------------- | :------------------------------------------ |
| 1. æ¨æ•²æŒ‡ç¤º | `agent_chat_page.py` | ãƒ‰ãƒ©ãƒ•ãƒˆå›ç­” + è©•ä¾¡ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é€ä¿¡ | `REFLECTION_INSTRUCTION` + ã€Œç¤¾å†…ãƒŠãƒ¬ãƒƒã‚¸ã«ã‚ˆã‚‹ã¨...ã€ |
| 2. è‡ªå·±è©•ä¾¡ | `Gemini (LLM)` | åŸºæº–ï¼ˆæ­£ç¢ºæ€§ãƒ»ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ã«å¾“ã£ã¦è©•ä¾¡ | ã€Œè‡ªå·±è©•ä¾¡: ...ä¿®æ­£ã¯ä¸è¦ã¨åˆ¤æ–­ã—ã¾ã—ãŸã€‚ã€ |
| 3. æœ€çµ‚åŒ– | `Gemini (LLM)` | ä¿®æ­£ç‰ˆï¼ˆã¾ãŸã¯ãã®ã¾ã¾ï¼‰ã®å›ç­”ã‚’å‡ºåŠ› | ã€Œç¤¾å†…ãƒŠãƒ¬ãƒƒã‚¸ã«ã‚ˆã‚‹ã¨...ï¼ˆæœ€çµ‚å›ç­”ï¼‰ã€ |


### CoT (Chain of Thought) ã®å‡¦ç†æ§‹é€ ã¨å®Ÿä¾‹

ReActã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€æœ€çµ‚çš„ãªå›ç­”ã‚’å‡ºã™å‰ã«ã€æ€è€ƒ(Thought)ã¨è¡Œå‹•(Action/Tool Call)ã‚’é€£é–ã•ã›ã€è«–ç†çš„ã«ç­”ãˆã‚’å°ãå‡ºã—ã¾ã™ã€‚
ä»¥ä¸‹ã¯ã€å®Ÿéš›ã®å®Ÿè¡Œãƒ­ã‚°ã«åŸºã¥ãæ€è€ƒã®é€£é–ãƒ—ãƒ­ã‚»ã‚¹ã§ã™ã€‚

#### å…·ä½“çš„ãªæŒ™å‹•ã®ä»•çµ„ã¿ (å®Ÿè¡Œãƒ­ã‚°ã®è¿½è·¡)

1. **åˆæœŸæ€è€ƒ (Initial Thought)**
    *   **å…¥åŠ›**: ã€Œå®Ÿé¨“ç”Ÿç‰©å­¦ã§ã¯ã€ç”Ÿç‰©ã®æ©Ÿæ§‹ã‚’è§£æ˜ã™ã‚‹ãŸã‚ã«ã©ã®ã‚ˆã†ãªæ“ä½œã‚’åŠ ãˆã¾ã™ã‹ï¼Ÿã€
    *   **LLMã®æ¨è«–**: è³ªå•ã®æ„å›³ã‚’ç†è§£ã—ã€å¤–éƒ¨æƒ…å ±ãŒå¿…è¦ã‹åˆ¤æ–­ã—ã¾ã™ã€‚
    *   **æ€è€ƒãƒ­ã‚°**:
        > ğŸ§  Thought: [ç”Ÿç‰©ã®æ©Ÿæ§‹ã‚’è§£æ˜ã™ã‚‹ãŸã‚ã®æ“ä½œã«é–¢ã™ã‚‹è³ªå•ãªã®ã§ã€ä¸€èˆ¬çš„ãªçŸ¥è­˜ã¨ã—ã¦wikipediaã‚’æ¤œç´¢ã—ã¦ã¿ã‚‹ã€‚]

2. **ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œ (Action & Observation)**
    *   **LLMã®è¡Œå‹•**: æ¨è«–ã«åŸºã¥ãã€é©åˆ‡ãªãƒ„ãƒ¼ãƒ«ã¨å¼•æ•°ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
    *   **ãƒ„ãƒ¼ãƒ«å‘¼ã³å‡ºã—**:
        > ğŸ› ï¸ Tool Call: `search_rag_knowledge_base`
        > Args: `{'collection_name': 'wikipedia_ja', 'query': 'å®Ÿé¨“ç”Ÿç‰©å­¦ ç”Ÿç‰©æ©Ÿæ§‹ æ“ä½œ'}`
    *   **ãƒ„ãƒ¼ãƒ«ã®çµæœ (Observation)**:
        > ğŸ“ Tool Result: Result 1 (Score: 0.50): Q: å®Ÿé¨“ç”Ÿç‰©å­¦ã§ã¯... A: äººç‚ºçš„ã«æ“ä½œã‚’åŠ ãˆé€šå¸¸ã¨ç•°ãªã‚‹æ¡ä»¶ã‚’ä½œã‚Šå‡ºã—...

3. **è§£æ±ºæ€è€ƒ (Reasoning & Draft)**
    *   **LLMã®æ¨è«–**: æ¤œç´¢çµæœã‚’èª­ã¿ã€è³ªå•ã«ç­”ãˆã‚‰ã‚Œã‚‹ã‹åˆ¤æ–­ã—ã¾ã™ã€‚
    *   **æ€è€ƒãƒ­ã‚°**:
        > ğŸ§  Thought: [æ¤œç´¢çµæœã‹ã‚‰ã€è³ªå•ã«å¯¾ã™ã‚‹å›ç­”ãŒå¾—ã‚‰ã‚ŒãŸã€‚]
    *   **ãƒ‰ãƒ©ãƒ•ãƒˆå›ç­”**:
        > Answer: ç¤¾å†…ãƒŠãƒ¬ãƒƒã‚¸ã«ã‚ˆã‚‹ã¨ã€å®Ÿé¨“ç”Ÿç‰©å­¦ã§ã¯...

4. **æ¨æ•² (Reflection)**
    *   **LLMã®è‡ªå·±è©•ä¾¡**:
        > ğŸ¤” Reflection Thought: ** [è‡ªå·±è©•ä¾¡: å›ç­”ã¯è³ªå•ã«ç›´æ¥çš„ã‹ã¤æ˜ç¢ºã«ç­”ãˆã¦ãŠã‚Š...ä¿®æ­£ã¯ä¸è¦ã¨åˆ¤æ–­ã—ã¾ã—ãŸã€‚]**

#### ã¾ã¨ã‚

| ã‚¹ãƒ†ãƒƒãƒ— | ãƒ•ã‚§ãƒ¼ã‚º | å‡¦ç†å†…å®¹ | å®Ÿéš›ã®ãƒ­ã‚°è¦ç´  |
| :--- | :--- | :--- | :--- |
| **1** | **Thought** | æ¤œç´¢ã®å¿…è¦æ€§ã¨æˆ¦ç•¥ã®ç«‹æ¡ˆ | `Thought: ...wikipediaã‚’æ¤œç´¢ã—ã¦ã¿ã‚‹ã€‚` |
| **2** | **Action** | æ¤œç´¢ãƒ„ãƒ¼ãƒ«ã®å®Ÿè¡Œ | `Tool Call: search_rag_knowledge_base` |
| **3** | **Observation** | æ¤œç´¢çµæœã®å–å¾— | `Tool Result: ...äººç‚ºçš„ã«æ“ä½œã‚’åŠ ãˆ...` |
| **4** | **Draft** | æƒ…å ±ã®çµ±åˆã¨å›ç­”ä½œæˆ | `Answer: ç¤¾å†…ãƒŠãƒ¬ãƒƒã‚¸ã«ã‚ˆã‚‹ã¨...` |
| **5** | **Reflection** | å›ç­”ã®å“è³ªãƒã‚§ãƒƒã‚¯ | `Reflection Thought: ...ä¿®æ­£ã¯ä¸è¦ã¨åˆ¤æ–­...` |
